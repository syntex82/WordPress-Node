{{> header}}
<style>
  .product-section { padding: 3rem 0; }
  .product-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: start; }
  .product-gallery { position: sticky; top: 100px; }
  .product-main-image { border-radius: var(--border-radius); overflow: hidden; background: var(--color-surface); border: 1px solid var(--color-border); aspect-ratio: 1; }
  .product-main-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
  .product-main-image:hover img { transform: scale(1.05); }
  .product-thumbnails { display: flex; gap: 0.75rem; margin-top: 1rem; }
  .product-thumb { width: 80px; height: 80px; border-radius: var(--border-radius-sm); overflow: hidden; border: 2px solid var(--color-border); cursor: pointer; transition: all 0.2s; }
  .product-thumb:hover, .product-thumb.active { border-color: var(--color-primary); }
  .product-thumb img { width: 100%; height: 100%; object-fit: cover; }

  .product-info h1 { font-size: 2rem; margin-bottom: 1rem; line-height: 1.3; }
  .product-price { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem; }
  .product-price .current { background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .product-price .original { color: var(--color-text-muted); text-decoration: line-through; font-size: 1.25rem; font-weight: 400; }
  .product-price .discount { background: var(--color-error); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 600; }

  .product-meta { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
  .meta-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 25px; font-size: 0.9rem; }
  .meta-item .icon { color: var(--color-primary); }

  .product-description { color: var(--color-text-muted); line-height: 1.7; margin-bottom: 2rem; }
  .product-description h2, .product-description h3 { color: var(--color-heading); margin-top: 1.5rem; margin-bottom: 0.75rem; }

  /* Variant Selectors */
  .variant-selector { margin-bottom: 1.5rem; }
  .variant-selector label { display: block; font-weight: 600; margin-bottom: 0.75rem; color: var(--color-heading); }
  .variant-selector .selected-value { font-weight: 400; color: var(--color-text-muted); }

  .size-options { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .size-option { min-width: 48px; height: 44px; padding: 0 1rem; display: flex; align-items: center; justify-content: center; border: 2px solid var(--color-border); border-radius: var(--border-radius-sm); background: var(--color-surface); cursor: pointer; font-weight: 500; transition: all 0.2s; }
  .size-option:hover { border-color: var(--color-primary); }
  .size-option.selected { border-color: var(--color-primary); background: var(--color-primary); color: white; }
  .size-option.out-of-stock { opacity: 0.4; cursor: not-allowed; text-decoration: line-through; }

  .color-options { display: flex; flex-wrap: wrap; gap: 0.75rem; }
  .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--color-border); cursor: pointer; transition: all 0.2s; position: relative; }
  .color-option:hover { transform: scale(1.1); }
  .color-option.selected { border-color: var(--color-primary); box-shadow: 0 0 0 2px var(--color-background), 0 0 0 4px var(--color-primary); }
  .color-option.out-of-stock::after { content: ''; position: absolute; top: 50%; left: -2px; right: -2px; height: 2px; background: var(--color-error); transform: rotate(-45deg); }
  .color-option .color-name { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; white-space: nowrap; opacity: 0; transition: opacity 0.2s; }
  .color-option:hover .color-name { opacity: 1; }

  .variant-stock-status { margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: var(--border-radius-sm); font-size: 0.9rem; }
  .variant-stock-status.in-stock { background: rgba(34, 197, 94, 0.1); color: var(--color-success); border: 1px solid rgba(34, 197, 94, 0.3); }
  .variant-stock-status.low-stock { background: rgba(234, 179, 8, 0.1); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
  .variant-stock-status.out-of-stock { background: rgba(239, 68, 68, 0.1); color: var(--color-error); border: 1px solid rgba(239, 68, 68, 0.3); }

  .quantity-selector { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
  .quantity-selector label { font-weight: 500; }
  .qty-controls { display: flex; align-items: center; border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); overflow: hidden; }
  .qty-btn { width: 44px; height: 44px; background: var(--color-surface); border: none; cursor: pointer; font-size: 1.25rem; color: var(--color-text); transition: all 0.2s; }
  .qty-btn:hover { background: var(--color-background); color: var(--color-primary); }
  .qty-input { width: 60px; height: 44px; border: none; background: var(--color-background); text-align: center; font-size: 1rem; color: var(--color-text); }

  .add-to-cart-btn { padding: 1rem 2rem; font-size: 1.1rem; }
  .add-to-cart-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .product-features { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border); }
  .product-features h3 { margin-bottom: 1rem; font-size: 1rem; }
  .features-list { display: grid; gap: 0.75rem; }
  .feature-item { display: flex; align-items: center; gap: 0.75rem; font-size: 0.95rem; color: var(--color-text-muted); }
  .feature-item .check { color: var(--color-success); }

  @media (max-width: 1024px) {
    .product-layout { grid-template-columns: 1fr; }
    .product-gallery { position: static; }
  }
</style>

<section class="product-section">
  <div class="container">
    <div class="product-layout">
      <div class="product-gallery">
        <div class="product-main-image" id="mainImage">
          {{#if product.images.[0]}}
          <img src="{{product.images.[0]}}" alt="{{product.name}}" id="mainProductImage" onerror="this.src='https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=600&h=600&fit=crop'">
          {{else}}
          <img src="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=600&h=600&fit=crop" alt="{{product.name}}" id="mainProductImage">
          {{/if}}
        </div>
        {{#if product.images.[1]}}
        <div class="product-thumbnails">
          {{#each product.images}}
          <div class="product-thumb {{#if @first}}active{{/if}}" data-image="{{this}}">
            <img src="{{this}}" alt="Product image {{@index}}">
          </div>
          {{/each}}
        </div>
        {{/if}}
      </div>

      <div class="product-info">
        <h1>{{product.name}}</h1>

        <div class="product-price">
          {{#if product.salePrice}}
          <span class="current">${{product.salePrice}}</span>
          <span class="original">${{product.price}}</span>
          <span class="discount">SALE</span>
          {{else}}
          <span class="current">${{product.price}}</span>
          {{/if}}
        </div>

        <div class="product-meta">
          {{#if product.sku}}<span class="meta-item"><span class="icon">üè∑Ô∏è</span> SKU: <span id="variantSku">{{product.sku}}</span></span>{{/if}}
          <span class="meta-item"><span class="icon">üì¶</span> {{#if (eq product.type 'DIGITAL')}}Digital Product{{else}}Physical Product{{/if}}</span>
          {{#unless product.hasVariants}}
            {{#if product.stock}}<span class="meta-item"><span class="icon">‚úì</span> In Stock ({{product.stock}})</span>{{/if}}
          {{/unless}}
        </div>

        <div class="product-description">
          {{{product.description}}}
        </div>

        {{!-- Variant Selectors - show if variants exist --}}
        {{#if product.hasVariants}}
          <div id="variantSelectors">
            {{!-- Build available sizes/colors from variants --}}
            <script type="application/json" id="variantConfig">
              {{{json product.variantOptions}}}
            </script>

            {{!-- Size Selector --}}
            <div class="variant-selector" id="sizeSelector" style="display: none;">
              <label>Size: <span class="selected-value" id="selectedSizeLabel"></span></label>
              <div class="size-options" id="sizeOptions"></div>
            </div>

            {{!-- Color Selector --}}
            <div class="variant-selector" id="colorSelector" style="display: none;">
              <label>Color: <span class="selected-value" id="selectedColorLabel"></span></label>
              <div class="color-options" id="colorOptions"></div>
            </div>

            {{!-- Variant Stock Status --}}
            <div class="variant-stock-status" id="variantStockStatus" style="display: none;">
              <span id="stockStatusText"></span>
            </div>

            {{!-- Variant SKU display --}}
            <div class="variant-sku" id="variantSkuDisplay" style="display: none;">
              <span class="text-muted">SKU: </span><span id="variantSku"></span>
            </div>
          </div>
        {{/if}}

        <div class="quantity-selector">
          <label>Quantity:</label>
          <div class="qty-controls">
            <button class="qty-btn" id="qtyMinus">‚àí</button>
            <input type="number" class="qty-input" id="qtyInput" value="1" min="1" max="99">
            <button class="qty-btn" id="qtyPlus">+</button>
          </div>
        </div>

        <button class="btn btn-primary add-to-cart-btn" id="addToCartBtn" data-product-id="{{product.id}}" {{#if product.hasVariants}}disabled{{/if}}>
          {{#if product.hasVariants}}Select Options{{else}}üõí Add to Cart{{/if}}
        </button>

        {{!-- Hidden variant data for JavaScript --}}
        {{#if product.hasVariants}}
        <script type="application/json" id="variantData">
          {{{json product.variants}}}
        </script>
        {{/if}}

        <div class="product-features">
          <h3>Why buy from us?</h3>
          <div class="features-list">
            <div class="feature-item"><span class="check">‚úì</span> Secure checkout</div>
            <div class="feature-item"><span class="check">‚úì</span> Fast delivery</div>
            <div class="feature-item"><span class="check">‚úì</span> 30-day money back guarantee</div>
            <div class="feature-item"><span class="check">‚úì</span> 24/7 customer support</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  // Thumbnail gallery
  document.querySelectorAll('.product-thumb').forEach(function(thumb) {
    thumb.addEventListener('click', function() {
      document.querySelectorAll('.product-thumb').forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');
      document.getElementById('mainProductImage').src = this.dataset.image;
    });
  });

  // Quantity controls
  var qtyInput = document.getElementById('qtyInput');
  document.getElementById('qtyMinus').addEventListener('click', function() {
    var val = parseInt(qtyInput.value) || 1;
    if (val > 1) qtyInput.value = val - 1;
  });
  document.getElementById('qtyPlus').addEventListener('click', function() {
    var val = parseInt(qtyInput.value) || 1;
    if (val < 99) qtyInput.value = val + 1;
  });

  // Variant selection logic
  var variants = [];
  var variantConfig = null;
  var selectedSize = null;
  var selectedColor = null;
  var selectedVariant = null;
  var hasVariants = false;
  var availableSizes = [];
  var availableColors = [];
  var originalPrice = document.querySelector('.product-price .current')?.textContent || '';

  // Load variant data if available
  var variantDataEl = document.getElementById('variantData');
  var variantConfigEl = document.getElementById('variantConfig');

  if (variantDataEl) {
    try {
      variants = JSON.parse(variantDataEl.textContent.trim()) || [];
      hasVariants = variants.length > 0;
    } catch (e) {
      console.error('Failed to parse variant data:', e);
    }
  }

  if (variantConfigEl) {
    try {
      variantConfig = JSON.parse(variantConfigEl.textContent.trim()) || {};
    } catch (e) {
      console.error('Failed to parse variant config:', e);
    }
  }

  // Extract unique sizes and colors from variants
  if (hasVariants) {
    var sizeSet = new Set();
    var colorMap = new Map();

    variants.forEach(function(v) {
      if (v.size) sizeSet.add(v.size);
      if (v.color) {
        colorMap.set(v.color, v.colorCode || '#888888');
      }
    });

    // Use config sizes if available (maintains order), otherwise use extracted
    if (variantConfig && variantConfig.sizes && variantConfig.sizes.length > 0) {
      availableSizes = variantConfig.sizes.filter(function(s) { return sizeSet.has(s); });
    } else {
      availableSizes = Array.from(sizeSet);
    }

    // Use config colors if available (has color codes), otherwise use extracted
    if (variantConfig && variantConfig.colors && variantConfig.colors.length > 0) {
      availableColors = variantConfig.colors.filter(function(c) {
        return colorMap.has(c.name);
      });
    } else {
      availableColors = Array.from(colorMap.entries()).map(function(entry) {
        return { name: entry[0], code: entry[1] };
      });
    }

    // Build size options dynamically
    if (availableSizes.length > 0) {
      var sizeSelector = document.getElementById('sizeSelector');
      var sizeOptionsContainer = document.getElementById('sizeOptions');
      if (sizeSelector && sizeOptionsContainer) {
        sizeSelector.style.display = 'block';
        availableSizes.forEach(function(size) {
          var div = document.createElement('div');
          div.className = 'size-option';
          div.dataset.size = size;
          div.textContent = size;
          div.addEventListener('click', function() {
            if (this.classList.contains('out-of-stock')) return;
            document.querySelectorAll('.size-option').forEach(function(o) { o.classList.remove('selected'); });
            this.classList.add('selected');
            selectedSize = this.dataset.size;
            document.getElementById('selectedSizeLabel').textContent = selectedSize;
            updateVariantUI();
          });
          sizeOptionsContainer.appendChild(div);
        });
      }
    }

    // Build color options dynamically
    if (availableColors.length > 0) {
      var colorSelector = document.getElementById('colorSelector');
      var colorOptionsContainer = document.getElementById('colorOptions');
      if (colorSelector && colorOptionsContainer) {
        colorSelector.style.display = 'block';
        availableColors.forEach(function(color) {
          var div = document.createElement('div');
          div.className = 'color-option';
          div.dataset.color = color.name;
          div.dataset.colorCode = color.code;
          div.style.backgroundColor = color.code;
          div.title = color.name;
          var span = document.createElement('span');
          span.className = 'color-name';
          span.textContent = color.name;
          div.appendChild(span);
          div.addEventListener('click', function() {
            if (this.classList.contains('out-of-stock')) return;
            document.querySelectorAll('.color-option').forEach(function(o) { o.classList.remove('selected'); });
            this.classList.add('selected');
            selectedColor = this.dataset.color;
            document.getElementById('selectedColorLabel').textContent = selectedColor;
            updateVariantUI();
          });
          colorOptionsContainer.appendChild(div);
        });
      }
    }
  }

  // Find matching variant based on selected size and color
  function findVariant() {
    if (!hasVariants) return null;
    return variants.find(function(v) {
      var sizeMatch = availableSizes.length === 0 || !selectedSize || v.size === selectedSize;
      var colorMatch = availableColors.length === 0 || !selectedColor || v.color === selectedColor;
      return sizeMatch && colorMatch && v.isActive !== false;
    });
  }

  // Update UI based on selected variant
  function updateVariantUI() {
    var btn = document.getElementById('addToCartBtn');
    var priceEl = document.querySelector('.product-price .current');
    var stockStatusEl = document.getElementById('variantStockStatus');
    var stockTextEl = document.getElementById('stockStatusText');
    var skuEl = document.getElementById('variantSku');
    var skuDisplay = document.getElementById('variantSkuDisplay');

    selectedVariant = findVariant();
    if (!hasVariants) return;

    // Check if selection is complete
    var needsSize = availableSizes.length > 0;
    var needsColor = availableColors.length > 0;
    var selectionComplete = (!needsSize || selectedSize) && (!needsColor || selectedColor);

    if (!selectionComplete) {
      btn.disabled = true;
      btn.innerHTML = 'Select Options';
      if (stockStatusEl) stockStatusEl.style.display = 'none';
      if (skuDisplay) skuDisplay.style.display = 'none';
      return;
    }

    if (selectedVariant) {
      // Update price if variant has custom price
      if (selectedVariant.price && priceEl) {
        priceEl.textContent = '$' + parseFloat(selectedVariant.price).toFixed(2);
      }

      // Update SKU
      if (skuEl && selectedVariant.sku) {
        skuEl.textContent = selectedVariant.sku;
        if (skuDisplay) skuDisplay.style.display = 'block';
      }

      // Update stock status
      if (stockStatusEl && stockTextEl) {
        stockStatusEl.style.display = 'block';
        var stock = selectedVariant.stock || 0;
        var lowThreshold = 5;

        stockStatusEl.className = 'variant-stock-status';
        if (stock === 0) {
          stockStatusEl.classList.add('out-of-stock');
          stockTextEl.textContent = '‚ùå Out of Stock';
          btn.disabled = true;
          btn.innerHTML = 'Out of Stock';
        } else if (stock <= lowThreshold) {
          stockStatusEl.classList.add('low-stock');
          stockTextEl.textContent = '‚ö†Ô∏è Only ' + stock + ' left in stock!';
          btn.disabled = false;
          btn.innerHTML = 'üõí Add to Cart';
        } else {
          stockStatusEl.classList.add('in-stock');
          stockTextEl.textContent = '‚úì In Stock (' + stock + ' available)';
          btn.disabled = false;
          btn.innerHTML = 'üõí Add to Cart';
        }
      }

      // Update variant image if available
      if (selectedVariant.image) {
        document.getElementById('mainProductImage').src = selectedVariant.image;
      }

      // Store variant ID on button
      btn.dataset.variantId = selectedVariant.id;
    } else {
      btn.disabled = true;
      btn.innerHTML = 'Unavailable';
      delete btn.dataset.variantId;
      if (stockStatusEl) {
        stockStatusEl.style.display = 'block';
        stockStatusEl.className = 'variant-stock-status out-of-stock';
        stockTextEl.textContent = '‚ùå This combination is not available';
      }
    }
  }

  // Add to cart
  document.getElementById('addToCartBtn').addEventListener('click', async function() {
    var productId = this.dataset.productId;
    var variantId = this.dataset.variantId;
    var quantity = parseInt(qtyInput.value) || 1;
    var btn = this;
    var originalText = btn.innerHTML;

    if (hasVariants && !variantId) {
      alert('Please select all options before adding to cart');
      return;
    }

    btn.innerHTML = '‚è≥ Adding...';
    btn.disabled = true;

    try {
      var success = await window.addToCart('product', productId, quantity, variantId);
      if (success) {
        btn.innerHTML = '‚úì Added to Cart!';
        setTimeout(function() {
          btn.innerHTML = originalText;
          if (!hasVariants || selectedVariant) btn.disabled = false;
        }, 2000);
      } else {
        btn.innerHTML = originalText;
        if (!hasVariants || selectedVariant) btn.disabled = false;
      }
    } catch (e) {
      btn.innerHTML = originalText;
      if (!hasVariants || selectedVariant) btn.disabled = false;
    }
  });
})();
</script>
{{> footer}}
