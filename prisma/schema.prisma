generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AnalyticsEvent {
  id String @id @default(cuid())
  sessionId String?
  userId    String?
  category  String
  action    String
  label     String?
  value     Float?
  path      String?
  metadata  Json?
  ipAddress String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([category])
  @@index([createdAt])
  @@index([sessionId])
}

model AnalyticsSession {
  id String @id @default(cuid())
  userId      String?
  ipAddress   String?
  userAgent   String?
  device      String?
  browser     String?
  os          String?
  country     String?
  city        String?
  referer     String?
  landingPage String?
  exitPage    String?
  pageCount   Int       @default(0)
  duration    Int       @default(0)
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  isActive    Boolean   @default(true)

  @@index([isActive])
  @@index([startedAt])
  @@index([userId])
}

model Backup {
  id String @id @default(cuid())
  name             String
  description      String?
  type             BackupType      @default(FULL)
  status           BackupStatus    @default(PENDING)
  filePath         String?
  fileSize         BigInt?
  checksum         String?
  includesDatabase Boolean         @default(true)
  includesMedia    Boolean         @default(true)
  includesThemes   Boolean         @default(true)
  includesPlugins  Boolean         @default(true)
  tablesCount      Int?
  recordsCount     Int?
  filesCount       Int?
  errorMessage     String?
  isScheduled      Boolean         @default(false)
  scheduleId       String?
  createdById      String?           // SECURITY: Cascade delete when user is deleted
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime        @default(now())
  createdBy        User?           @relation(fields: [createdById], references: [id], onDelete: SetNull)
  UpdateHistory    UpdateHistory[]

  @@index([createdAt])
  @@index([createdById])
  @@index([status])
  @@index([type])
}

model BackupSchedule {
  id String @id @default(cuid())
  name           String
  isActive       Boolean    @default(true)
  frequency      String
  cronExpression String?
  hour           Int        @default(3)
  dayOfWeek      Int?
  dayOfMonth     Int?
  backupType     BackupType @default(FULL)
  retentionDays  Int        @default(30)
  maxBackups     Int        @default(10)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdAt      DateTime   @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([nextRunAt])
}

model Badge {
  id String @id @default(cuid())
  name        String      @unique
  slug        String      @unique
  description String?
  icon        String?
  color       String?
  category    String?
  criteria    Json?
  createdAt   DateTime    @default(now())
  UserBadge   UserBadge[]
}

model BlockedIP {
  id String @id @default(cuid())
  ip        String    @unique
  reason    String
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
  @@index([ip])
}

model Cart {
  id String @id @default(cuid())
  userId     String?    @unique
  sessionId  String?    @unique
  couponCode String?
  createdAt  DateTime   @default(now())
  updatedAt DateTime @updatedAt
  items      CartItem[]

  @@index([sessionId])
  @@index([userId])
}

model CartItem {
  id String @id @default(cuid())
  cartId         String
  productId      String?
  variantId      String?
  quantity       Int             @default(1)
  createdAt      DateTime        @default(now())
  updatedAt DateTime @updatedAt
  courseId       String?
  itemType       CartItemType    @default(PRODUCT)
  cart           Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  course         Course?         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  product        Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([cartId, courseId])
  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([courseId])
  @@index([productId])
}

model Certificate {
  id String @id @default(cuid())
  certificateNumber String    @unique
  courseId          String
  userId            String
  issuedAt          DateTime  @default(now())
  pdfPath           String?
  pdfUrl            String?
  verificationHash  String    @unique
  metadata          Json?
  revokedAt         DateTime?
  revokedReason     String?
  createdAt         DateTime  @default(now())
  updatedAt DateTime @updatedAt
  course            Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([certificateNumber])
  @@index([courseId])
  @@index([userId])
  @@index([verificationHash])
}

model CertificateTemplate {
  id String @id @default(cuid())
  name              String
  isDefault         Boolean  @default(false)
  logoUrl           String?
  primaryColor      String   @default("#6366f1")
  secondaryColor    String   @default("#a5b4fc")
  backgroundColor   String   @default("#f8fafc")
  textColor         String   @default("#1e293b")
  accentColor       String   @default("#6366f1")
  titleFont         String   @default("Helvetica-Bold")
  bodyFont          String   @default("Helvetica")
  titleFontSize     Int      @default(42)
  nameFontSize      Int      @default(36)
  courseFontSize    Int      @default(28)
  bodyFontSize      Int      @default(14)
  titleText         String   @default("Certificate of Completion")
  subtitleText      String   @default("This is to certify that")
  completionText    String   @default("has successfully completed the course")
  brandingText      String   @default("NodePress LMS")
  showBorder        Boolean  @default(true)
  showLogo          Boolean  @default(true)
  showBranding      Boolean  @default(true)
  borderWidth       Int      @default(3)
  borderStyle       String   @default("double")
  customCSS         String?
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isDefault])
}

model ContentType {
  id String @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  fields      Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id String @id @default(cuid())
  participant1Id                         String
  participant2Id                         String
  lastMessageAt                          DateTime?
  createdAt                              DateTime        @default(now())
  updatedAt DateTime @updatedAt
  participant1 User            @relation("Conversation_participant1IdToUser", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User            @relation("Conversation_participant2IdToUser", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages                          DirectMessage[]

  @@unique([participant1Id, participant2Id])
  @@index([lastMessageAt])
  @@index([participant1Id])
  @@index([participant2Id])
}

model Coupon {
  id String @id @default(cuid())
  code           String     @unique
  description    String?
  type           CouponType @default(PERCENTAGE)
  value          Decimal    @db.Decimal(10, 2)
  minOrderAmount Decimal?   @db.Decimal(10, 2)
  maxDiscount    Decimal?   @db.Decimal(10, 2)
  usageLimit     Int?
  usageCount     Int        @default(0)
  perUserLimit   Int?
  startsAt       DateTime?
  expiresAt      DateTime?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

model Course {
  id String @id @default(cuid())
  slug                String           @unique
  title               String
  description         String?
  shortDescription    String?
  category            String?
  level               CourseLevel      @default(BEGINNER)
  featuredImage       String?
  instructorId        String
  priceType           CoursePriceType  @default(FREE)
  priceAmount         Decimal?         @db.Decimal(10, 2)
  status              CourseStatus     @default(DRAFT)
  passingScorePercent Int              @default(80)
  certificateEnabled  Boolean          @default(true)
  estimatedHours      Int?
  whatYouLearn        Json?
  requirements        Json?
  createdAt           DateTime         @default(now())
  updatedAt DateTime @updatedAt
  // Demo isolation
  demoInstanceId      String?
  demoInstance        DemoInstance?    @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  CartItem            CartItem[]
  Certificate         Certificate[]
  instructor          User             @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  modules             CourseModule[]
  enrollments         Enrollment[]
  lessons             Lesson[]
  LessonProgress      LessonProgress[]
  OrderItem           OrderItem[]
  quizzes             Quiz[]
  QuizAttempt         QuizAttempt[]
  // i18n - translations for this course
  translations        CourseTranslation[]

  @@index([category])
  @@index([instructorId])
  @@index([priceType])
  @@index([slug])
  @@index([status])
  @@index([demoInstanceId])
}

model CourseModule {
  id String @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int      @default(0)
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]

  @@index([courseId])
  @@index([orderIndex])
}

model CustomTheme {
  id String @id @default(cuid())
  name        String   @unique
  description String?
  settings    Json
  customCSS   String?
  pages       Json?
  isActive    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  previewUrl  String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([isActive])
}

model CustomerAddress {
  id String @id @default(cuid())
  userId     String
  type       AddressType @default(SHIPPING)
  isDefault  Boolean     @default(false)
  firstName  String
  lastName   String
  company    String?
  address1   String
  address2   String?
  city       String
  state      String?
  postalCode String
  country    String
  phone      String?
  createdAt  DateTime    @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([userId])
}

model Developer {
  id String @id @default(cuid())
  userId              String            @unique
  displayName         String
  slug                String            @unique
  headline            String?
  bio                 String?
  profileImage        String?
  coverImage          String?
  category            DeveloperCategory @default(FULLSTACK)
  skills              String[]
  languages           String[]
  frameworks          String[]
  tools               String[]
  spokenLanguages     String[]
  yearsOfExperience   Int               @default(0)
  education           Json?
  certifications      Json?
  portfolio           Json?
  hourlyRate          Decimal           @db.Decimal(10, 2)
  minimumBudget       Decimal?          @db.Decimal(10, 2)
  currency            String            @default("USD")
  availability        String            @default("available")
  availableHours      Int               @default(40)
  timezone            String?
  status              DeveloperStatus   @default(PENDING)
  isVerified          Boolean           @default(false)
  verifiedAt          DateTime?
  isFeatured          Boolean           @default(false)
  featuredUntil       DateTime?
  rating              Float             @default(0)
  reviewCount         Int               @default(0)
  projectsCompleted   Int               @default(0)
  totalEarnings       Decimal           @default(0) @db.Decimal(10, 2)
  responseTime        Int?
  completionRate      Float             @default(100)
  websiteUrl          String?
  githubUrl           String?
  linkedinUrl         String?
  twitterUrl          String?
  applicationNote     String?
  rejectionReason     String?
  suspensionReason    String?
  stripeConnectId     String?           @unique
  stripeAccountStatus String?
  createdAt           DateTime          @default(now())
  updatedAt DateTime @updatedAt
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  DeveloperPayout     DeveloperPayout[]
  reviews             DeveloperReview[]
  HiringRequest       HiringRequest[]
  Project             Project[]

  // Marketplace products by this developer
  plugins             MarketplacePlugin[]
  themes              MarketplaceTheme[]

  @@index([availability])
  @@index([category])
  @@index([isFeatured])
  @@index([rating])
  @@index([slug])
  @@index([status])
}

model DeveloperPayout {
  id String @id @default(cuid())
  developerId      String
  amount           Decimal      @db.Decimal(10, 2)
  currency         String       @default("USD")
  status           PayoutStatus @default(PENDING)
  stripePayoutId   String?
  stripeTransferId String?
  payoutMethod     String       @default("stripe")
  accountLast4     String?
  requestedAt      DateTime     @default(now())
  processedAt      DateTime?
  failureReason    String?
  createdAt        DateTime     @default(now())
  updatedAt DateTime @updatedAt
  developer        Developer    @relation(fields: [developerId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([requestedAt])
  @@index([status])
}

model DeveloperReview {
  id String @id @default(cuid())
  developerId         String
  reviewerId          String
  projectId           String?
  overallRating       Int
  communicationRating Int?
  qualityRating       Int?
  timelinessRating    Int?
  valueRating         Int?
  title               String?
  content             String?
  isVerified          Boolean   @default(false)
  isApproved          Boolean   @default(true)
  response            String?
  respondedAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt DateTime @updatedAt
  developer           Developer @relation(fields: [developerId], references: [id], onDelete: Cascade)
  reviewer            User      @relation(fields: [reviewerId], references: [id], onDelete: Cascade)

  @@unique([developerId, reviewerId, projectId])
  @@index([developerId])
  @@index([isApproved])
  @@index([overallRating])
  @@index([reviewerId])
}

model DirectMessage {
  id String @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  media          Json?        @default("[]")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([isRead])
  @@index([senderId])
}

model EmailLog {
  id String @id @default(cuid())
  templateId        String?
  recipientId       String?
  toEmail           String
  toName            String?
  fromEmail         String
  fromName          String?
  subject           String
  htmlContent       String?
  textContent       String?
  status            EmailStatus    @default(PENDING)
  sentAt            DateTime?
  deliveredAt       DateTime?
  failedAt          DateTime?
  errorMessage      String?
  providerMessageId String?
  providerResponse  Json?
  metadata          Json?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime       @default(now())
  updatedAt DateTime @updatedAt
  recipient         User?          @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  template          EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([recipientId])
  @@index([sentAt])
  @@index([status])
  @@index([templateId])
  @@index([toEmail])
}

model EmailTemplate {
  id String @id @default(cuid())
  name        String
  slug        String            @unique
  type        EmailTemplateType @default(CUSTOM)
  subject     String
  htmlContent String
  textContent String?
  variables   Json?
  isActive    Boolean           @default(true)
  isSystem    Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt DateTime @updatedAt
  createdById String?
  emailLogs   EmailLog[]
  createdBy   User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([isActive])
  @@index([slug])
  @@index([type])
}

model Enrollment {
  id String @id @default(cuid())
  courseId    String
  userId      String
  status      EnrollmentStatus @default(ACTIVE)
  enrolledAt  DateTime         @default(now())
  completedAt DateTime?
  expiresAt   DateTime?
  paymentId   String?
  createdAt   DateTime         @default(now())
  updatedAt DateTime @updatedAt
  pricePaid   Float?           @default(0)
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([status])
  @@index([userId])
}

model Group {
  id String @id @default(cuid())
  name         String
  slug         String          @unique
  description  String?
  visibility   GroupVisibility @default(PUBLIC)
  ownerId      String
  createdAt    DateTime        @default(now())
  updatedAt DateTime @updatedAt
  owner        User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members      GroupMember[]
  messages     GroupMessage[]

  @@index([createdAt])
  @@index([ownerId])
  @@index([slug])
  @@index([visibility])
}

model GroupMember {
  id String @id @default(cuid())
  groupId  String
  userId   String
  role     GroupMemberRole @default(MEMBER)
  isBanned Boolean         @default(false)
  joinedAt DateTime        @default(now())
  group    Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([joinedAt])
  @@index([userId])
}

model GroupMessage {
  id String @id @default(cuid())
  groupId   String
  senderId  String
  content   String
  createdAt DateTime @default(now())
  media     Json?    @default("[]")
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([groupId])
  @@index([senderId])
}

model HiringRequest {
  id String @id @default(cuid())
  clientId        String
  developerId     String
  title           String
  description     String
  requirements    String?
  attachments     Json?
  budgetType      String              @default("fixed")
  budgetAmount    Decimal             @db.Decimal(10, 2)
  estimatedHours  Int?
  deadline        DateTime?
  status          HiringRequestStatus @default(PENDING)
  responseMessage String?
  respondedAt     DateTime?
  projectId       String?             @unique
  createdAt       DateTime            @default(now())
  updatedAt DateTime @updatedAt
  client          User                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  developer       Developer           @relation(fields: [developerId], references: [id], onDelete: Cascade)
  project         Project?

  @@index([clientId])
  @@index([createdAt])
  @@index([developerId])
  @@index([status])
}

model Lesson {
  id String @id @default(cuid())
  courseId         String
  title            String
  content          String?
  orderIndex       Int              @default(0)
  type             LessonType       @default(VIDEO)
  videoAssetId     String?
  estimatedMinutes Int?
  isPreview        Boolean          @default(false)
  isRequired       Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt DateTime @updatedAt
  moduleId         String?
  course           Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module           CourseModule?    @relation(fields: [moduleId], references: [id])
  videoAsset       VideoAsset?      @relation(fields: [videoAssetId], references: [id])
  LessonProgress   LessonProgress[]
  quiz             Quiz?

  @@index([courseId])
  @@index([moduleId])
  @@index([orderIndex])
}

model LessonProgress {
  id String @id @default(cuid())
  courseId            String
  lessonId            String
  userId              String
  videoWatchedSeconds Int       @default(0)
  lessonCompleted     Boolean   @default(false)
  completedAt         DateTime?
  lastAccessedAt      DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt DateTime @updatedAt
  course              Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson              Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, lessonId, userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([userId])
}

model ManualRecommendation {
  id String @id @default(cuid())
  ruleId             String
  contentType        String
  contentId          String
  position           Int                @default(0)
  createdAt          DateTime           @default(now())
  RecommendationRule RecommendationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([contentType, contentId])
  @@index([ruleId])
}

// ==================== LICENSING SYSTEM ====================

model License {
  id              String              @id @default(cuid())
  licenseKey      String              @unique
  email           String
  tier            LicenseTier
  status          LicenseStatus       @default(ACTIVE)

  // Restrictions
  maxSites        Int                 @default(1)
  allowedDomains  Json?               // Array of allowed domain patterns

  // Features
  features        Json                @default("[]")

  // Dates
  purchaseOrderId String?             @unique
  expiresAt       DateTime?           // null = lifetime
  lastValidated   DateTime?

  // Customer info
  customerName    String?
  companyName     String?
  metadata        Json?

  // Relations
  activations     LicenseActivation[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([email])
  @@index([status])
  @@index([tier])
  @@index([expiresAt])
}

model LicenseActivation {
  id          String   @id @default(cuid())
  licenseId   String
  domain      String
  ipAddress   String?
  serverInfo  Json?    // Server fingerprint for validation
  activatedAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  isActive    Boolean  @default(true)

  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@unique([licenseId, domain])
  @@index([licenseId])
  @@index([domain])
  @@index([isActive])
}

enum LicenseTier {
  PERSONAL
  PROFESSIONAL
  AGENCY
  ENTERPRISE
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  REVOKED
}

// ==================== PLUGIN PURCHASES ====================

model PluginPurchase {
  id           String            @id @default(cuid())
  userId       String
  pluginId     String
  orderId      String?
  licenseKey   String?           @unique
  purchaseDate DateTime          @default(now())
  expiresAt    DateTime?         // For subscription-based plugins
  status       String            @default("active")

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  plugin       MarketplacePlugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([userId, pluginId])
  @@index([userId])
  @@index([pluginId])
  @@index([status])
}

model ThemePurchase {
  id           String           @id @default(cuid())
  userId       String
  themeId      String
  orderId      String?
  licenseKey   String?          @unique
  purchaseDate DateTime         @default(now())
  expiresAt    DateTime?
  status       String           @default("active")

  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme        MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@unique([userId, themeId])
  @@index([userId])
  @@index([themeId])
  @@index([status])
}

// ==================== PROFESSIONAL SERVICES ====================

model ProfessionalService {
  id           String          @id @default(cuid())
  name         String
  slug         String          @unique
  description  String          @db.Text
  category     ServiceCategory
  priceType    PriceType
  hourlyRate   Decimal?        @db.Decimal(10, 2)
  fixedPrice   Decimal?        @db.Decimal(10, 2)
  minHours     Int?
  maxHours     Int?
  isActive     Boolean         @default(true)
  isFeatured   Boolean         @default(false)
  features     Json            @default("[]")
  deliverables Json            @default("[]")
  image        String?
  sortOrder    Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  bookings     ServiceBooking[]
}

model ServiceBooking {
  id            String        @id @default(cuid())
  serviceId     String
  userId        String
  status        BookingStatus @default(PENDING)
  scheduledDate DateTime?
  completedDate DateTime?
  hours         Decimal?      @db.Decimal(5, 2)
  totalAmount   Decimal       @db.Decimal(10, 2)
  notes         String?       @db.Text
  requirements  Json?
  paymentId     String?
  orderId       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  service       ProfessionalService @relation(fields: [serviceId], references: [id])
  user          User                @relation(fields: [userId], references: [id])

  @@index([serviceId])
  @@index([userId])
  @@index([status])
  @@index([scheduledDate])
}

enum ServiceCategory {
  CONSULTING
  DEVELOPMENT
  TRAINING
  SUPPORT
  MIGRATION
  HOSTING
  DESIGN
  SECURITY
}

enum PriceType {
  HOURLY
  FIXED
  SUBSCRIPTION
  QUOTE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REFUNDED
}

// ==================== MARKETPLACE PLUGINS ====================

model MarketplacePlugin {
  id String @id @default(cuid())
  name                                       String
  slug                                       String                    @unique
  description                                String?
  longDescription                            String?
  version                                    String
  author                                     String
  authorEmail                                String?
  authorUrl                                  String?
  iconUrl                                    String?
  screenshotUrls                             Json?
  downloadUrl                                String?
  repositoryUrl                              String?
  fileSize                                   Int?
  category                                   String                    @default("utility")
  tags                                       Json?
  features                                   Json?
  price                                      Float                     @default(0)
  isPremium                                  Boolean                   @default(false)
  downloads                                  Int                       @default(0)
  activeInstalls                             Int                       @default(0)
  rating                                     Float                     @default(0)
  ratingCount                                Int                       @default(0)
  status                                     String                    @default("pending")
  submittedById                              String?
  approvedById                               String?
  approvedAt                                 DateTime?
  rejectionReason                            String?
  isFeatured                                 Boolean                   @default(false)
  featuredOrder                              Int?
  minVersion                                 String?
  maxVersion                                 String?
  testedUpTo                                 String?
  changelog                                  String?
  documentation                              String?
  supportUrl                                 String?
  licenseType                                String?                   @default("MIT")
  createdAt                                  DateTime                  @default(now())
  updatedAt DateTime @updatedAt
  approvedBy  User?                     @relation("MarketplacePlugin_approvedByIdToUser", fields: [approvedById], references: [id], onDelete: SetNull)
  submittedBy User?                     @relation("MarketplacePlugin_submittedByIdToUser", fields: [submittedById], references: [id], onDelete: SetNull)
  ratings                    MarketplacePluginRating[]
  purchases                  PluginPurchase[]
  developerId                String?
  developer                  Developer?                @relation(fields: [developerId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([downloads])
  @@index([isFeatured])
  @@index([rating])
  @@index([status])
  @@index([submittedById])
}

model MarketplacePluginRating {
  id String @id @default(cuid())
  pluginId          String
  userId            String
  rating            Int
  review            String?
  createdAt         DateTime          @default(now())
  updatedAt DateTime @updatedAt
  MarketplacePlugin MarketplacePlugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pluginId, userId])
  @@index([pluginId])
  @@index([userId])
}

model MarketplaceSettings {
  id String @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MarketplaceTheme {
  id String @id @default(cuid())
  name                                      String
  slug                                      String                   @unique
  description                               String?
  longDescription                           String?
  version                                   String
  author                                    String
  authorEmail                               String?
  authorUrl                                 String?
  thumbnailUrl                              String?
  screenshotUrls                            Json?
  downloadUrl                               String?
  demoUrl                                   String?
  repositoryUrl                             String?
  fileSize                                  Int?
  category                                  String                   @default("blog")
  tags                                      Json?
  features                                  Json?
  price                                     Float                    @default(0)
  isPremium                                 Boolean                  @default(false)
  downloads                                 Int                      @default(0)
  rating                                    Float                    @default(0)
  ratingCount                               Int                      @default(0)
  status                                    String                   @default("pending")
  submittedById                             String?
  approvedById                              String?
  approvedAt                                DateTime?
  rejectionReason                           String?
  isFeatured                                Boolean                  @default(false)
  featuredOrder                             Int?
  minVersion                                String?
  maxVersion                                String?
  changelog                                 String?
  documentation                             String?
  supportUrl                                String?
  licenseType                               String?                  @default("GPL-2.0")
  createdAt                                 DateTime                 @default(now())
  updatedAt DateTime @updatedAt
  approvedBy  User?                    @relation("MarketplaceTheme_approvedByIdToUser", fields: [approvedById], references: [id], onDelete: SetNull)
  submittedBy User?                    @relation("MarketplaceTheme_submittedByIdToUser", fields: [submittedById], references: [id], onDelete: SetNull)
  ratings                    MarketplaceThemeRating[]
  purchases                  ThemePurchase[]
  developerId                String?
  developer                  Developer?               @relation(fields: [developerId], references: [id], onDelete: SetNull)

  @@index([category])
  @@index([downloads])
  @@index([isFeatured])
  @@index([rating])
  @@index([status])
  @@index([submittedById])
}

model MarketplaceThemeRating {
  id String @id @default(cuid())
  themeId          String
  userId           String
  rating           Int
  review           String?
  createdAt        DateTime         @default(now())
  updatedAt DateTime @updatedAt
  theme MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([themeId, userId])
  @@index([themeId])
  @@index([userId])
}

model MarketplaceTransaction {
  id String @id @default(cuid())
  projectId             String
  type                  MarketplaceTransactionType
  amount                Decimal                      @db.Decimal(10, 2)
  currency              String                       @default("USD")
  description           String?
  status                MarketplaceTransactionStatus @default(PENDING)
  stripePaymentIntentId String?
  stripeTransferId      String?
  stripeChargeId        String?
  fromUserId            String?
  toUserId              String?
  metadata              Json?
  processedAt           DateTime?
  failureReason         String?
  createdAt             DateTime                     @default(now())
  updatedAt DateTime @updatedAt
  project               Project                      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([projectId])
  @@index([status])
  @@index([type])
}

model Media {
  id String @id @default(cuid())
  filename     String
  originalName String
  path         String
  mimeType     String
  size         Int
  width        Int?
  height       Int?
  alt          String?
  caption      String?
  uploadedById String
  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Demo isolation
  demoInstanceId String?
  demoInstance   DemoInstance? @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([mimeType])
  @@index([uploadedById])
  @@index([demoInstanceId])
}

model Menu {
  id String @id @default(cuid())
  name      String     @unique
  location  String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime @updatedAt
  items     MenuItem[]
}

model MenuItem {
  id String @id @default(cuid())
  menuId         String
  parentId       String?
  label          String
  url            String?
  target         String       @default("_self")
  type           MenuItemType @default(CUSTOM)
  pageId         String?
  postId         String?
  order          Int          @default(0)
  cssClass       String?
  icon           String?
  createdAt      DateTime     @default(now())
  updatedAt DateTime @updatedAt
  menu           Menu         @relation(fields: [menuId], references: [id], onDelete: Cascade)
  page           Page?        @relation(fields: [pageId], references: [id])
  parent         MenuItem?    @relation("MenuItemToMenuItem", fields: [parentId], references: [id])
  children       MenuItem[]   @relation("MenuItemToMenuItem")
  post           Post?        @relation(fields: [postId], references: [id])

  @@index([menuId])
  @@index([order])
  @@index([parentId])
}

model Notification {
  id String @id @default(cuid())
  userId    String
  type      NotificationType @default(INFO)
  title     String
  message   String
  link      String?
  icon      String?
  iconColor String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([type])
  @@index([userId])
}

model Order {
  id String @id @default(cuid())
  orderNumber     String        @unique
  userId          String?
  email           String
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @default(0) @db.Decimal(10, 2)
  shipping        Decimal       @default(0) @db.Decimal(10, 2)
  discount        Decimal       @default(0) @db.Decimal(10, 2)
  total           Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  couponCode      String?
  couponDiscount  Decimal?      @db.Decimal(10, 2)
  billingAddress  Json
  shippingAddress Json?
  shippingMethod  String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  customerNote    String?
  adminNote       String?
  createdAt       DateTime      @default(now())
  updatedAt DateTime @updatedAt
  items           OrderItem[]
  payments        Payment[]

  @@index([createdAt])
  @@index([email])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([status])
  @@index([userId])
}

model OrderItem {
  id String @id @default(cuid())
  orderId        String
  productId      String?
  variantId      String?
  courseId       String?
  itemType       CartItemType    @default(PRODUCT)
  name           String
  sku            String?
  price          Decimal         @db.Decimal(10, 2)
  quantity       Int
  total          Decimal         @db.Decimal(10, 2)
  options        Json?
  createdAt      DateTime        @default(now())
  order          Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product?        @relation(fields: [productId], references: [id])
  ProductVariant ProductVariant? @relation(fields: [variantId], references: [id])
  course         Course?         @relation(fields: [courseId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([courseId])
}

model Page {
  id String @id @default(cuid())
  title             String
  slug              String             @unique
  content           String
  template          String?
  featuredImage     String?
  status            PostStatus         @default(DRAFT)
  publishedAt       DateTime?
  authorId          String
  metaTitle         String?
  metaDescription   String?
  customFields      Json?
  parentId          String?
  createdAt         DateTime           @default(now())
  updatedAt DateTime @updatedAt
  // Demo isolation
  demoInstanceId    String?
  demoInstance      DemoInstance?      @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  MenuItem          MenuItem[]
  author              User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent            Page?              @relation("PageToPage", fields: [parentId], references: [id])
  children          Page[]             @relation("PageToPage")
  PageCustomization PageCustomization?
  // i18n - translations for this page
  translations      PageTranslation[]

  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([demoInstanceId])
}

model PageCustomization {
  id String @id @default(cuid())
  pageId                String   @unique
  layout                String?
  showHeader            Boolean  @default(true)
  showFooter            Boolean  @default(true)
  showSidebar           Boolean  @default(false)
  customCSS             String?
  backgroundColor       String?
  textColor             String?
  headerStyle           String?
  footerStyle           String?
  featuredImagePosition String?
  customFields          Json?
  createdAt             DateTime @default(now())
  updatedAt DateTime @updatedAt
  page                  Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId])
}

model PageView {
  id String @id @default(cuid())
  path        String
  userId      String?
  ipAddress   String?
  userAgent   String?
  referer     String?
  createdAt   DateTime @default(now())
  browser     String?
  city        String?
  country     String?
  device      String?
  duration    Int?
  os          String?
  scrollDepth Int?
  sessionId   String?
  User        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([country])
  @@index([createdAt])
  @@index([device])
  @@index([path])
  @@index([sessionId])
}

model PasswordHistory {
  id String @id @default(cuid())
  userId    String
  password  String
  createdAt DateTime @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model PasswordPolicy {
  id String @id @default(cuid())
  minLength              Int      @default(8)
  requireUppercase       Boolean  @default(true)
  requireLowercase       Boolean  @default(true)
  requireNumbers         Boolean  @default(true)
  requireSpecialChars    Boolean  @default(true)
  expirationDays         Int?
  preventReuse           Int      @default(5)
  checkBreachedPasswords Boolean  @default(false)
  enabled                Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id String @id @default(cuid())
  orderId               String
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("USD")
  status                PaymentStatus @default(UNPAID)
  method                String        @default("stripe")
  stripePaymentIntentId String?       @unique
  stripeChargeId        String?
  stripeCustomerId      String?
  stripeReceiptUrl      String?
  refundedAmount        Decimal?      @db.Decimal(10, 2)
  refundReason          String?
  refundedAt            DateTime?
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt DateTime @updatedAt
  order                 Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model Plugin {
  id String @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  version     String
  author      String?
  description String?
  path        String
  config      Json
  isActive    Boolean  @default(false)
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Post {
  id String @id @default(cuid())
  title             String
  slug              String             @unique
  content           String
  excerpt           String?
  featuredImage     String?
  status            PostStatus         @default(DRAFT)
  publishedAt       DateTime?
  authorId          String
  metaTitle         String?
  metaDescription   String?
  customFields      Json?
  createdAt         DateTime           @default(now())
  updatedAt DateTime @updatedAt
  // Demo isolation - null for real posts, set for demo posts
  demoInstanceId    String?
  demoInstance      DemoInstance?      @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  MenuItem          MenuItem[]
  author              User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  PostCustomization PostCustomization?
  // i18n - translations for this post
  translations      PostTranslation[]

  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([demoInstanceId])
}

model PostCustomization {
  id String @id @default(cuid())
  postId                String   @unique
  layout                String?
  showHeader            Boolean  @default(true)
  showFooter            Boolean  @default(true)
  showSidebar           Boolean  @default(false)
  showAuthor            Boolean  @default(true)
  showDate              Boolean  @default(true)
  showCategory          Boolean  @default(true)
  showTags              Boolean  @default(true)
  showRelatedPosts      Boolean  @default(true)
  relatedPostsCount     Int      @default(3)
  customCSS             String?
  backgroundColor       String?
  textColor             String?
  featuredImagePosition String?
  customFields          Json?
  createdAt             DateTime @default(now())
  updatedAt DateTime @updatedAt
  post                  Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model Product {
  id String @id @default(cuid())
  name              String
  slug              String           @unique
  description       String?
  shortDescription  String?
  sku               String?          @unique
  price             Decimal          @db.Decimal(10, 2)
  salePrice         Decimal?         @db.Decimal(10, 2)
  costPrice         Decimal?         @db.Decimal(10, 2)
  stock             Int              @default(0)
  lowStockThreshold Int              @default(5)
  trackStock        Boolean          @default(true)
  status            ProductStatus    @default(DRAFT)
  type              ProductType      @default(PHYSICAL)
  featuredImage     String?
  images            Json?
  weight            Decimal?         @db.Decimal(10, 3)
  dimensions        Json?
  downloadUrl       String?
  downloadLimit     Int?
  downloadExpiry    Int?
  metaTitle         String?
  metaDescription   String?
  categoryId        String?
  createdAt         DateTime         @default(now())
  updatedAt DateTime @updatedAt
  hasVariants       Boolean          @default(false)
  variantOptions    Json?
  // Demo isolation
  demoInstanceId    String?
  demoInstance      DemoInstance?    @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  CartItem          CartItem[]
  OrderItem         OrderItem[]
  category          ProductCategory? @relation(fields: [categoryId], references: [id])
  reviews           ProductReview[]
  variants          ProductVariant[]
  tags              ProductTag[]
  // i18n - translations for this product
  translations      ProductTranslation[]

  @@index([categoryId])
  @@index([hasVariants])
  @@index([sku])
  @@index([slug])
  @@index([status])
  @@index([demoInstanceId])
}

model ProductCategory {
  id String @id @default(cuid())
  name                  String
  slug                  String            @unique
  description           String?
  image                 String?
  parentId              String?
  createdAt             DateTime          @default(now())
  updatedAt DateTime @updatedAt
  products              Product[]
  parent                ProductCategory?  @relation("ProductCategoryToProductCategory", fields: [parentId], references: [id])
  children              ProductCategory[] @relation("ProductCategoryToProductCategory")
  // i18n - translations for this category
  translations          CategoryTranslation[]

  @@index([parentId])
  @@index([slug])
}

model ProductOption {
  id String @id @default(cuid())
  type         ProductOptionType
  name         String
  value        String
  displayValue String?
  metadata     Json?
  sortOrder    Int               @default(0)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, value])
  @@index([isActive])
  @@index([type])
}

model ProductReview {
  id String @id @default(cuid())
  productId  String
  userId     String?
  name       String
  email      String
  rating     Int
  title      String?
  content    String?
  isVerified Boolean  @default(false)
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isApproved])
  @@index([productId])
  @@index([rating])
}

model ProductTag {
  id String @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  Product   Product[]

  @@index([slug])
}

model ProductVariant {
  id String @id @default(cuid())
  productId         String
  name              String
  sku               String?     @unique
  price             Decimal?    @db.Decimal(10, 2)
  salePrice         Decimal?    @db.Decimal(10, 2)
  stock             Int         @default(0)
  image             String?
  options           Json
  isDefault         Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt DateTime @updatedAt
  color             String?
  colorCode         String?
  costPrice         Decimal?    @db.Decimal(10, 2)
  images            Json?
  isActive          Boolean     @default(true)
  lowStockThreshold Int         @default(5)
  size              String?
  sortOrder         Int         @default(0)
  weight            Decimal?    @db.Decimal(10, 3)
  CartItem          CartItem[]
  OrderItem         OrderItem[]
  product           Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([color])
  @@index([isActive])
  @@index([productId])
  @@index([size])
  @@index([sku])
}

model Project {
  id String @id @default(cuid())
  clientId               String
  developerId            String
  title                  String
  description            String
  requirements           String?
  deliverables           Json?
  budgetType             String                   @default("fixed")
  totalBudget            Decimal                  @db.Decimal(10, 2)
  hourlyRate             Decimal?                 @db.Decimal(10, 2)
  hoursLogged            Decimal                  @default(0) @db.Decimal(10, 2)
  amountPaid             Decimal                  @default(0) @db.Decimal(10, 2)
  amountInEscrow         Decimal                  @default(0) @db.Decimal(10, 2)
  platformFee            Decimal                  @default(0) @db.Decimal(10, 2)
  platformFeePercent     Float                    @default(10)
  startDate              DateTime?
  deadline               DateTime?
  completedAt            DateTime?
  status                 ProjectStatus            @default(DRAFT)
  progress               Int                      @default(0)
  milestones             Json?
  files                  Json?
  clientRating           Int?
  clientReview           String?
  developerRating        Int?
  developerReview        String?
  createdAt              DateTime                 @default(now())
  updatedAt DateTime @updatedAt
  transactions           MarketplaceTransaction[]
  client                 User                     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  developer              Developer                @relation(fields: [developerId], references: [id], onDelete: Cascade)
  hiringRequest          HiringRequest            @relation(fields: [id], references: [projectId])
  disputes               ProjectDispute[]
  messages               ProjectMessage[]

  @@index([clientId])
  @@index([createdAt])
  @@index([developerId])
  @@index([status])
}

model ProjectDispute {
  id String @id @default(cuid())
  projectId     String
  initiatorId   String
  initiatorType String
  reason        String
  description   String
  evidence      Json?
  status        DisputeStatus @default(OPEN)
  resolution    String?
  resolvedById  String?
  resolvedAt    DateTime?
  refundAmount  Decimal?      @db.Decimal(10, 2)
  createdAt     DateTime      @default(now())
  updatedAt DateTime @updatedAt
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([projectId])
  @@index([status])
}

model ProjectMessage {
  id String @id @default(cuid())
  projectId   String
  senderId    String
  content     String
  attachments Json?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([projectId])
  @@index([senderId])
}

model Question {
  id String @id @default(cuid())
  quizId            String
  type              QuestionType @default(MCQ)
  prompt            String
  optionsJson       Json?
  correctAnswerJson Json
  explanation       String?
  points            Int          @default(1)
  orderIndex        Int          @default(0)
  createdAt         DateTime     @default(now())
  updatedAt DateTime @updatedAt
  quiz              Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([orderIndex])
  @@index([quizId])
}

model Quiz {
  id String @id @default(cuid())
  courseId            String
  lessonId            String?       @unique
  title               String
  description         String?
  timeLimitSeconds    Int?
  attemptsAllowed     Int?
  shuffleQuestions    Boolean       @default(false)
  passingScorePercent Int?
  isRequired          Boolean       @default(true)
  orderIndex          Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt DateTime @updatedAt
  questions           Question[]
  course              Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson              Lesson?       @relation(fields: [lessonId], references: [id])
  attempts            QuizAttempt[]

  @@index([courseId])
  @@index([lessonId])
}

model QuizAttempt {
  id String @id @default(cuid())
  quizId           String
  courseId         String
  userId           String
  startedAt        DateTime  @default(now())
  submittedAt      DateTime?
  scorePercent     Int?
  scorePoints      Int?
  maxPoints        Int?
  passed           Boolean   @default(false)
  answersJson      Json?
  attemptNumber    Int       @default(1)
  timeSpentSeconds Int?
  createdAt        DateTime  @default(now())
  updatedAt DateTime @updatedAt
  course           Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz             Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([attemptNumber])
  @@index([courseId])
  @@index([quizId])
  @@index([userId])
}

model RateLimitConfig {
  id String @id @default(cuid())
  endpoint      String   @unique
  windowMs      Int      @default(60000)
  maxRequests   Int      @default(100)
  enabled       Boolean  @default(true)
  blockDuration Int?
  createdAt     DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RateLimitViolation {
  id String @id @default(cuid())
  ip        String
  endpoint  String
  requests  Int
  limit     Int
  blockedAt DateTime  @default(now())
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  @@index([endpoint])
  @@index([ip])
}

model RecommendationCache {
  id String @id @default(cuid())
  sourceType      String
  sourceId        String
  targetType      String
  algorithm       String
  recommendations Json
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sourceType, sourceId, targetType, algorithm])
  @@index([expiresAt])
}

model RecommendationClick {
  id String @id @default(cuid())
  userId             String?
  sessionId          String?
  sourceType         String
  sourceId           String
  recommendationType String
  clickedType        String
  clickedId          String
  position           Int?
  createdAt          DateTime @default(now())
  User               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([recommendationType])
  @@index([sourceType, sourceId])
  @@index([userId])
}

model RecommendationRule {
  id String @id @default(cuid())
  name                 String
  description          String?
  sourceType           String
  sourceId             String?
  targetType           String
  algorithm            String
  settings             Json?
  priority             Int                    @default(0)
  isActive             Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt DateTime @updatedAt
  manualItems ManualRecommendation[]

  @@index([algorithm])
  @@index([isActive])
  @@index([priority])
  @@index([sourceType, sourceId])
  @@index([targetType])
}

model RecommendationSettings {
  id String @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecurityEvent {
  id String @id @default(cuid())
  userId    String?
  type      SecurityEventType
  ip        String?
  userAgent String?
  metadata  Json?
  createdAt DateTime          @default(now())
  user      User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([ip])
  @@index([type])
  @@index([userId])
}

model SeoAuditLog {
  id String @id @default(cuid())
  contentType String
  contentId   String
  score       Int
  issues      Json
  suggestions Json
  createdAt   DateTime @default(now())

  @@index([contentType, contentId])
  @@index([createdAt])
}

model SeoRedirect {
  id String @id @default(cuid())
  fromPath  String    @unique
  toPath    String
  type      Int       @default(301)
  isActive  Boolean   @default(true)
  hitCount  Int       @default(0)
  lastHitAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromPath])
  @@index([isActive])
}

model SeoSchemaMarkup {
  id String @id @default(cuid())
  name      String
  type      String
  content   Json
  scope     String   @default("global")
  scopeId   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([scope])
  @@index([type])
}

model SeoSitemapEntry {
  id String @id @default(cuid())
  url        String   @unique
  priority   Float    @default(0.5)
  changefreq String   @default("weekly")
  lastmod    DateTime @default(now())
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Session {
  id String @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ip           String?
  lastActivity DateTime @default(now())
  updatedAt DateTime @updatedAt
  userAgent    String?
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Setting {
  id String @id @default(cuid())
  key       String   @unique
  value     Json
  type      String
  group     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([group])
  @@index([key])
}

model SetupStatus {
  id String @id @default(cuid())
  setupComplete    Boolean   @default(false)
  adminCreated     Boolean   @default(false)
  smtpConfigured   Boolean   @default(false)
  domainConfigured Boolean   @default(false)
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt DateTime @updatedAt
}

model ShippingMethod {
  id String @id @default(cuid())
  name        String
  description String?
  cost        Decimal  @db.Decimal(10, 2)
  freeAbove   Decimal? @db.Decimal(10, 2)
  minDays     Int?
  maxDays     Int?
  countries   String?
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Subscription {
  id String @id @default(cuid())
  userId               String             @unique
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  billingCycle         BillingCycle       @default(MONTHLY)
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?
  currentPeriodStart   DateTime           @default(now())
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  cancelReason         String?
  trialStart           DateTime?
  trialEnd             DateTime?
  metadata             Json?
  createdAt            DateTime           @default(now())
  updatedAt DateTime @updatedAt
  plan SubscriptionPlan @relation(fields: [planId], references: [id])
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([status])
  @@index([stripeSubscriptionId])
  @@index([userId])
}

model SubscriptionPlan {
  id String @id @default(cuid())
  name                 String
  slug                 String         @unique
  description          String?
  monthlyPrice         Decimal        @default(0) @db.Decimal(10, 2)
  yearlyPrice          Decimal        @default(0) @db.Decimal(10, 2)
  stripePriceIdMonthly String?
  stripePriceIdYearly  String?
  stripeProductId      String?
  maxUsers             Int?
  maxStorageMb         Int?
  maxProjects          Int?
  maxCourses           Int?
  maxProducts          Int?
  features             Json           @default("[]")
  isActive             Boolean        @default(true)
  isFeatured           Boolean        @default(false)
  displayOrder         Int            @default(0)
  badgeText            String?
  trialDays            Int            @default(0)
  createdAt            DateTime       @default(now())
  updatedAt DateTime @updatedAt
  Subscription         Subscription[]

  @@index([isActive])
  @@index([slug])
}

model SystemConfig {
  id String @id @default(cuid())
  key         String   @unique
  value       String
  isEncrypted Boolean  @default(false)
  group       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([group])
  @@index([key])
}

model SystemVersion {
  id String @id @default(cuid())
  version                String    @unique
  isCurrentVersion       Boolean   @default(false)
  installedAt            DateTime?
  releaseDate            DateTime?
  changelog              String?
  releaseNotes           String?
  minNodeVersion         String?
  minNpmVersion          String?
  breakingChanges        Boolean   @default(false)
  requiresManualSteps    Boolean   @default(false)
  manualStepsDescription String?
  downloadUrl            String?
  checksum               String?
  fileSize               BigInt?
  createdAt              DateTime  @default(now())
  updatedAt DateTime @updatedAt

  @@index([isCurrentVersion])
  @@index([version])
}

model TaxRate {
  id String @id @default(cuid())
  name        String
  rate        Decimal  @db.Decimal(5, 4)
  country     String
  state       String?
  postalCodes String?
  isDefault   Boolean  @default(false)
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
  @@index([isActive])
}

model Theme {
  id String @id @default(cuid())
  name                    String                    @unique
  slug                    String                    @unique
  version                 String
  author                  String?
  description             String?
  thumbnail               String?
  path                    String
  config                  Json
  isActive                Boolean                   @default(false)
  createdAt               DateTime                  @default(now())
  updatedAt DateTime @updatedAt
  customizationBlocks     ThemeCustomizationBlock[]
  customizationImages     ThemeCustomizationImage[]
  customizationLinks      ThemeCustomizationLink[]

  @@index([isActive])
}

model ThemeCustomizationBlock {
  id String @id @default(cuid())
  themeId         String
  name            String
  type            String
  title           String?
  description     String?
  content         String?
  richContent     Json?
  backgroundColor String?
  textColor       String?
  customCSS       String?
  layout          String?
  columns         Int      @default(1)
  padding         String?
  margin          String?
  backgroundImage String?
  featuredImage   String?
  isVisible       Boolean  @default(true)
  position        Int      @default(0)
  customData      Json?
  createdAt       DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme           Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([position])
  @@index([themeId])
  @@index([type])
}

model ThemeCustomizationImage {
  id String @id @default(cuid())
  themeId     String
  name        String
  type        String
  url         String
  altText     String?
  title       String?
  description String?
  width       Int?
  height      Int?
  mimeType    String?
  fileSize    Int?
  section     String?
  position    Int      @default(0)
  customData  Json?
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme       Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([section])
  @@index([themeId])
  @@index([type])
}

model ThemeCustomizationLink {
  id String @id @default(cuid())
  themeId    String
  name       String
  type       String
  label      String
  url        String
  icon       String?
  target     String   @default("_self")
  rel        String?
  title      String?
  className  String?
  customCSS  String?
  group      String?
  position   Int      @default(0)
  isVisible  Boolean  @default(true)
  isActive   Boolean  @default(true)
  customData Json?
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt
  theme      Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  @@index([group])
  @@index([position])
  @@index([themeId])
  @@index([type])
}

model UpdateHistory {
  id String @id @default(cuid())
  fromVersion    String
  toVersion      String
  status         UpdateStatus @default(PENDING)
  startedAt      DateTime     @default(now())
  completedAt    DateTime?
  changelog      String?
  releaseNotes   String?
  downloadUrl    String?
  checksum       String?
  fileSize       BigInt?
  backupId       String?
  migrationsRun  String[]
  migrationLogs  String?
  errorMessage   String?
  errorStack     String?
  initiatedBy    String?
  rolledBack     Boolean      @default(false)
  rollbackAt     DateTime?
  rollbackReason String?
  createdAt      DateTime     @default(now())
  updatedAt DateTime @updatedAt
  backup         Backup?      @relation(fields: [backupId], references: [id])
  initiatedByUser User?       @relation(fields: [initiatedBy], references: [id], onDelete: SetNull)

  @@index([fromVersion, toVersion])
  @@index([startedAt])
  @@index([status])
}

model User {
  id String @id @default(cuid())
  email                                                   String                    @unique
  name                                                    String
  password                                                String?
  role                                                    UserRole                  @default(STUDENT)
  avatar                                                  String?
  bio                                                     String?
  createdAt                                               DateTime                  @default(now())
  updatedAt DateTime @updatedAt
  accountLockedUntil                                      DateTime?
  failedLoginAttempts                                     Int                       @default(0)
  lastFailedLogin                                         DateTime?
  lastLoginAt                                             DateTime?
  lastLoginIp                                             String?
  recoveryCodes                                           Json?
  twoFactorEnabled                                        Boolean                   @default(false)
  twoFactorSecret                                         String?
  // Google OAuth fields
  googleId                                                String?                   @unique
  authProvider                                            String                    @default("local")
  // Demo isolation - null for real users, set for demo users
  demoInstanceId                                          String?
  demoInstance                                            DemoInstance?             @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)
  about                                                   String?
  company                                                 String?
  coursesCount                                            Int                       @default(0)
  coverImage                                              String?
  followersCount                                          Int                       @default(0)
  followingCount                                          Int                       @default(0)
  headline                                                String?
  interests                                               String[]
  isPublic                                                Boolean                   @default(true)
  jobTitle                                                String?
  location                                                String?
  postsCount                                              Int                       @default(0)
  skills                                                  String[]
  socialLinks                                             Json?
  username                                                String?                   @unique
  website                                                 String?
  passwordResetExpires                                    DateTime?
  passwordResetToken                                      String?                   @unique
  Backup                                                  Backup[]
  certificates                                            Certificate[]
  conversationsAsParticipant1          Conversation[]            @relation("Conversation_participant1IdToUser")
  conversationsAsParticipant2          Conversation[]            @relation("Conversation_participant2IdToUser")
  instructedCourses                                       Course[]
  CustomTheme                                             CustomTheme[]
  Developer                                               Developer?
  DeveloperReview                                         DeveloperReview[]
  DirectMessage                                           DirectMessage[]
  EmailLog                                                EmailLog[]
  EmailTemplate                                           EmailTemplate[]
  Enrollment                                              Enrollment[]
  Group                                                   Group[]
  GroupMember                                             GroupMember[]
  GroupMessage                                            GroupMessage[]
  HiringRequest                                           HiringRequest[]
  LessonProgress                                          LessonProgress[]
  MarketplacePlugin_MarketplacePlugin_approvedByIdToUser  MarketplacePlugin[]       @relation("MarketplacePlugin_approvedByIdToUser")
  MarketplacePlugin_MarketplacePlugin_submittedByIdToUser MarketplacePlugin[]       @relation("MarketplacePlugin_submittedByIdToUser")
  MarketplacePluginRating                                 MarketplacePluginRating[]
  MarketplaceTheme_MarketplaceTheme_approvedByIdToUser    MarketplaceTheme[]        @relation("MarketplaceTheme_approvedByIdToUser")
  MarketplaceTheme_MarketplaceTheme_submittedByIdToUser   MarketplaceTheme[]        @relation("MarketplaceTheme_submittedByIdToUser")
  MarketplaceThemeRating                                  MarketplaceThemeRating[]
  Media                                                   Media[]
  Notification                                            Notification[]
  Page                                                    Page[]
  PageView                                                PageView[]
  PasswordHistory                                         PasswordHistory[]
  posts                                                   Post[]
  Project                                                 Project[]
  QuizAttempt                                             QuizAttempt[]
  RecommendationClick                                     RecommendationClick[]
  SecurityEvent                                           SecurityEvent[]
  Session                                                 Session[]
  Subscription                                            Subscription?
  UpdateHistory                                           UpdateHistory[]
  UserBadge                                               UserBadge[]
  followers                  UserFollow[]              @relation("UserFollow_followingIdToUser")
  following                  UserFollow[]              @relation("UserFollow_followerIdToUser")
  UserInteraction                                         UserInteraction[]
  Activity                                                Activity[]
  timelinePosts              TimelinePost[]
  postLikes                  PostLike[]
  postComments               PostComment[]
  postShares                 PostShare[]
  mentionsReceived           PostMention[]             @relation("MentionedUser")
  mentionsMade               PostMention[]             @relation("MentionerUser")
  pricingSubscription        UserSubscription?         @relation("UserToSubscription")

  // Monetization relations
  pluginPurchases            PluginPurchase[]
  themePurchases             ThemePurchase[]
  serviceBookings            ServiceBooking[]
}

model UserBadge {
  id String @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  metadata Json?
  Badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([badgeId])
  @@index([userId])
}

model UserFollow {
  id String @id @default(cuid())
  followerId                        String
  followingId                       String
  createdAt                         DateTime @default(now())
  follower  User     @relation("UserFollow_followerIdToUser", fields: [followerId], references: [id], onDelete: Cascade)
  following User     @relation("UserFollow_followingIdToUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model UserInteraction {
  id String @id @default(cuid())
  userId          String?
  sessionId       String?
  contentType     String
  contentId       String
  interactionType String
  metadata        Json?
  createdAt       DateTime @default(now())
  User            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([contentType, contentId])
  @@index([createdAt])
  @@index([interactionType])
  @@index([sessionId])
  @@index([userId])
}

model Activity {
  id          String       @id @default(cuid())
  userId      String
  type        ActivityType
  targetType  String?      // post, course, user, etc.
  targetId    String?      // ID of the related content
  title       String
  description String?
  link        String?
  imageUrl    String?
  metadata    Json?
  isPublic    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([targetType, targetId])
  @@index([isPublic])
}

enum ActivityType {
  POST_PUBLISHED
  POST_LIKED
  POST_COMMENTED
  COURSE_ENROLLED
  COURSE_COMPLETED
  CERTIFICATE_EARNED
  BADGE_EARNED
  PROFILE_UPDATED
  NEW_FOLLOWER
  STARTED_FOLLOWING
  STATUS_UPDATE
}

// Timeline Posts - Rich content posts for social feed
model TimelinePost {
  id              String   @id @default(cuid())
  userId          String
  content         String?  @db.Text // Text content (can be empty for media-only posts)
  isPublic        Boolean  @default(true)
  likesCount      Int      @default(0)
  commentsCount   Int      @default(0)
  sharesCount     Int      @default(0)
  // For shared posts (retweet-style)
  originalPostId  String?  // Reference to original post if this is a share
  shareComment    String?  @db.Text // Optional comment when sharing
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  media        PostMedia[]
  likes        PostLike[]
  comments     PostComment[]
  shares       PostShare[]       // Users who shared this post
  originalPost TimelinePost?     @relation("PostShares", fields: [originalPostId], references: [id], onDelete: SetNull)
  sharedPosts  TimelinePost[]    @relation("PostShares") // Posts that are shares of this post
  hashtags     PostHashtag[]
  mentions     PostMention[]

  @@index([userId])
  @@index([createdAt])
  @@index([isPublic])
  @@index([originalPostId])
}

model PostMedia {
  id        String        @id @default(cuid())
  postId    String
  type      PostMediaType
  url       String
  thumbnail String?       // Thumbnail for videos or link preview image
  altText   String?
  width     Int?
  height    Int?
  duration  Int?          // Duration in seconds for videos/audio
  order     Int           @default(0)
  createdAt DateTime      @default(now())

  // Link preview metadata (for LINK type)
  linkTitle       String?
  linkDescription String?
  linkSiteName    String?

  post TimelinePost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

enum PostMediaType {
  IMAGE
  VIDEO
  GIF
  AUDIO
  LINK
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post TimelinePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostComment {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String   @db.Text
  parentId  String?  // For nested replies
  likesCount Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post   TimelinePost   @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent PostComment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies PostComment[] @relation("CommentReplies")

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

// Post Shares - Track who shared a post
model PostShare {
  id        String   @id @default(cuid())
  postId    String   // Original post being shared
  userId    String   // User who shared
  createdAt DateTime @default(now())

  post TimelinePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// Hashtags - Extracted from post content
model Hashtag {
  id        String   @id @default(cuid())
  tag       String   @unique // Normalized hashtag (lowercase, no #)
  postCount Int      @default(0) // Denormalized count for trending
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  posts PostHashtag[]

  @@index([postCount])
  @@index([tag])
}

// Many-to-many relationship between posts and hashtags
model PostHashtag {
  id        String   @id @default(cuid())
  postId    String
  hashtagId String
  createdAt DateTime @default(now())

  post    TimelinePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag Hashtag      @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@unique([postId, hashtagId])
  @@index([postId])
  @@index([hashtagId])
}

// Mentions - Track @username mentions in posts/comments
model PostMention {
  id              String   @id @default(cuid())
  postId          String?  // Mention in a post
  commentId       String?  // Mention in a comment
  mentionedUserId String   // User being mentioned
  mentionerUserId String   // User who wrote the mention
  createdAt       DateTime @default(now())

  post          TimelinePost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  mentionedUser User          @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  mentionerUser User          @relation("MentionerUser", fields: [mentionerUserId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([commentId])
  @@index([mentionedUserId])
  @@index([mentionerUserId])
}

model VideoAsset {
  id String @id @default(cuid())
  provider        VideoProvider @default(UPLOAD)
  url             String?
  playbackId      String?
  filePath        String?
  durationSeconds Int?
  isProtected     Boolean       @default(true)
  thumbnailUrl    String?
  createdAt       DateTime      @default(now())
  updatedAt DateTime @updatedAt
  Lesson          Lesson[]
}

enum AddressType {
  SHIPPING
  BILLING
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum BackupType {
  FULL
  DATABASE
  MEDIA
  THEMES
  PLUGINS
  SCHEDULED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum CartItemType {
  PRODUCT
  COURSE
}

enum CouponType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum CoursePriceType {
  FREE
  PAID
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum DeveloperCategory {
  FRONTEND
  BACKEND
  FULLSTACK
  WORDPRESS
  MOBILE
  DEVOPS
  DESIGN
  DATABASE
  SECURITY
  OTHER
}

enum DeveloperStatus {
  PENDING
  ACTIVE
  INACTIVE
  SUSPENDED
  REJECTED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED_CLIENT
  RESOLVED_DEVELOPER
  CLOSED
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum EmailTemplateType {
  WELCOME
  PASSWORD_RESET
  ORDER_CONFIRMATION
  COURSE_ENROLLMENT
  NEWSLETTER
  PROMOTIONAL
  CUSTOM
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum GroupMemberRole {
  OWNER
  MODERATOR
  MEMBER
}

enum GroupVisibility {
  PUBLIC
  PRIVATE
}

enum HiringRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  IN_PROGRESS
  COMPLETED
  DISPUTED
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
}

enum MarketplaceTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum MarketplaceTransactionType {
  ESCROW_DEPOSIT
  ESCROW_RELEASE
  ESCROW_REFUND
  PLATFORM_FEE
  DEVELOPER_PAYOUT
  DISPUTE_RESOLUTION
}

enum MenuItemType {
  CUSTOM
  PAGE
  POST
  HOME
  CATEGORY
  LOGIN
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
  USER_ACTION
  CONTENT
  SECURITY
  MARKETPLACE
  MENTION
  POST_LIKED
  POST_COMMENT
  POST_SHARED
  FOLLOW
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProductOptionType {
  SIZE
  COLOR
  MATERIAL
  STYLE
  CUSTOM
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductType {
  PHYSICAL
  DIGITAL
  SERVICE
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum QuestionType {
  MCQ
  MCQ_MULTI
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum SecurityEventType {
  SUCCESS_LOGIN
  FAILED_LOGIN
  FAILED_2FA
  LOCKOUT_TRIGGERED
  LOCKOUT_RELEASED
  PASSWORD_CHANGE
  EMAIL_CHANGE
  TWO_FA_ENABLED
  TWO_FA_DISABLED
  BLOCKED_REQUEST
  INTEGRITY_SCAN
  IP_BLOCKED
  IP_UNBLOCKED
  SECURITY_CHECK
  LOGOUT
  PASSWORD_RESET_REQUESTED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  CANCELLED   // Alias for CANCELED
  TRIALING
  TRIAL       // Alias for TRIALING
  PAUSED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  EXPIRED
}

enum UpdateStatus {
  PENDING
  DOWNLOADING
  DOWNLOADED
  BACKING_UP
  APPLYING
  MIGRATING
  VERIFYING
  COMPLETED
  FAILED
  ROLLED_BACK
}

enum UserRole {
  SUPER_ADMIN  // Full system access, can manage all demos and data
  ADMIN        // Site administrator, manages users within scope
  EDITOR       // Content editor, can edit all content
  AUTHOR       // Content author, can only edit own content
  INSTRUCTOR   // Course instructor, manages own courses
  STUDENT      // Course student, read-only course access
  USER         // Basic user, profile only
  VIEWER       // Legacy: read-only access (deprecated, use USER)
}

enum VideoProvider {
  UPLOAD
  HLS
  YOUTUBE
  VIMEO
}

// ==================== DEMO SYSTEM ====================

model DemoInstance {
  id              String            @id @default(cuid())
  subdomain       String            @unique
  name            String
  email           String
  company         String?
  phone           String?

  // Instance configuration
  databaseName    String            @unique
  port            Int               @unique
  containerId     String?
  status          DemoStatus        @default(PENDING)

  // Access credentials
  adminEmail      String
  adminPassword   String            // Hashed
  accessToken     String            @unique @default(cuid())

  // Lifecycle
  expiresAt       DateTime
  createdAt       DateTime          @default(now())
  startedAt       DateTime?
  lastAccessedAt  DateTime?

  // Resource usage
  cpuUsage        Float?
  memoryUsage     Float?
  diskUsage       Float?
  requestCount    Int               @default(0)

  // Analytics
  featuresUsed    Json?             // Track which features were explored
  pagesVisited    Json?             // Track page visits
  actionsPerformed Json?            // Track actions taken

  // Conversion tracking
  upgradeRequested Boolean          @default(false)
  upgradeRequestedAt DateTime?
  notes           String?
  expirationWarned Boolean          @default(false)

  // Relations
  accessLogs      DemoAccessLog[]
  featureUsage    DemoFeatureUsage[]
  sessions        DemoSession[]
  loginAttempts   DemoLoginAttempt[]

  // Demo data (isolated per demo instance)
  demoUsers       User[]
  demoPosts       Post[]
  demoPages       Page[]
  demoProducts    Product[]
  demoCourses     Course[]
  demoMedia       Media[]

  @@index([status])
  @@index([email])
  @@index([expiresAt])
  @@index([createdAt])
}

model DemoAccessLog {
  id              String        @id @default(cuid())
  demoInstanceId  String
  ipAddress       String?
  userAgent       String?
  path            String
  method          String
  statusCode      Int?
  responseTime    Int?          // milliseconds
  createdAt       DateTime      @default(now())

  demoInstance    DemoInstance  @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)

  @@index([demoInstanceId])
  @@index([createdAt])
  @@index([path])
}

model DemoFeatureUsage {
  id              String        @id @default(cuid())
  demoInstanceId  String
  feature         String        // e.g., "ai_theme_generator", "ecommerce", "lms"
  action          String        // e.g., "view", "create", "edit", "delete"
  metadata        Json?
  createdAt       DateTime      @default(now())

  demoInstance    DemoInstance  @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)

  @@index([demoInstanceId])
  @@index([feature])
  @@index([createdAt])
}

model DemoSession {
  id              String        @id @default(cuid())
  demoInstanceId  String
  ipAddress       String?
  userAgent       String?
  startedAt       DateTime      @default(now())
  endedAt         DateTime?
  duration        Int?          // in seconds
  pagesViewed     Int           @default(0)
  actionsCount    Int           @default(0)
  isActive        Boolean       @default(true)

  demoInstance    DemoInstance  @relation(fields: [demoInstanceId], references: [id], onDelete: Cascade)

  @@index([demoInstanceId])
  @@index([startedAt])
  @@index([isActive])
}

model DemoLoginAttempt {
  id              String        @id @default(cuid())
  demoInstanceId  String?
  email           String
  ipAddress       String?
  userAgent       String?
  success         Boolean
  failureReason   String?
  createdAt       DateTime      @default(now())

  demoInstance    DemoInstance? @relation(fields: [demoInstanceId], references: [id], onDelete: SetNull)

  @@index([demoInstanceId])
  @@index([email])
  @@index([success])
  @@index([createdAt])
}

model DemoConfig {
  id              String        @id @default(cuid())
  key             String        @unique
  value           String
  description     String?
  updatedAt       DateTime      @updatedAt
}

// Email verification for demo access requests
// Ensures only legitimate business users can access demos
model DemoVerification {
  id              String                    @id @default(cuid())
  email           String
  name            String
  company         String?
  phone           String?
  preferredSubdomain String?

  // Verification token (sent via email)
  token           String                    @unique
  tokenExpiresAt  DateTime

  // Verification status
  status          DemoVerificationStatus    @default(PENDING)
  verifiedAt      DateTime?

  // Resulting demo instance (after verification)
  demoInstanceId  String?

  // Security & audit
  ipAddress       String?
  userAgent       String?
  verificationAttempts Int                  @default(0)
  lastAttemptAt   DateTime?

  // Rate limiting
  emailSentCount  Int                       @default(1)
  lastEmailSentAt DateTime                  @default(now())

  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([email])
  @@index([token])
  @@index([status])
  @@index([createdAt])
  @@index([tokenExpiresAt])
}

enum DemoVerificationStatus {
  PENDING       // Waiting for email verification
  VERIFIED      // Email verified, demo can be created
  EXPIRED       // Token expired without verification
  BLOCKED       // Too many attempts, blocked
  COMPLETED     // Demo created successfully
}

enum DemoStatus {
  PENDING
  PROVISIONING
  RUNNING
  PAUSED
  EXPIRED
  TERMINATED
  ERROR
}

// ==================== AUDIT LOGGING ====================

model AuditLog {
  id              String        @id @default(cuid())
  userId          String?
  userEmail       String?
  userRole        String?
  action          String        // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  resource        String        // e.g., "user", "post", "product", "settings"
  resourceId      String?       // ID of the affected resource
  details         Json?         // Additional details about the action
  ipAddress       String?
  userAgent       String?
  success         Boolean       @default(true)
  errorMessage    String?
  createdAt       DateTime      @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([success])
}

// ==================== SUBSCRIPTION TIERS & PRICING ====================

model PricingPlan {
  id              String        @id @default(cuid())
  name            String        @unique  // e.g., "free", "starter", "professional", "enterprise"
  displayName     String        // e.g., "Free", "Starter", "Professional", "Enterprise"
  description     String?
  monthlyPrice    Decimal       @default(0) @db.Decimal(10, 2)
  yearlyPrice     Decimal       @default(0) @db.Decimal(10, 2)
  currency        String        @default("USD")

  // Feature limits
  maxUsers        Int           @default(1)
  maxPosts        Int           @default(10)
  maxPages        Int           @default(5)
  maxProducts     Int           @default(0)
  maxCourses      Int           @default(0)
  maxStudents     Int           @default(0)
  storageGb       Decimal       @default(1) @db.Decimal(10, 2)
  bandwidthGb     Decimal       @default(10) @db.Decimal(10, 2)

  // Feature flags
  hasEcommerce    Boolean       @default(false)
  hasLms          Boolean       @default(false)
  hasAi           Boolean       @default(false)
  hasPrioritySupport Boolean    @default(false)
  hasCustomDomain Boolean       @default(false)
  hasWhiteLabel   Boolean       @default(false)
  hasApi          Boolean       @default(false)
  hasAnalytics    Boolean       @default(false)
  hasSeo          Boolean       @default(true)
  hasMultilingual Boolean       @default(false)

  // Role restrictions - which roles this plan allows
  allowedRoles    String[]      @default(["USER", "AUTHOR"])

  isActive        Boolean       @default(true)
  isPopular       Boolean       @default(false)  // Highlight as recommended
  sortOrder       Int           @default(0)
  stripeMonthlyPriceId String?
  stripeYearlyPriceId  String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  userSubscriptions UserSubscription[]

  @@index([name])
  @@index([isActive])
}

model UserSubscription {
  id              String        @id @default(cuid())
  userId          String        @unique
  planId          String
  status          SubscriptionStatus @default(ACTIVE)
  billingCycle    BillingCycle  @default(MONTHLY)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean     @default(false)

  // Stripe integration
  stripeSubscriptionId String?   @unique
  stripeCustomerId     String?

  // Usage tracking
  postsUsed       Int           @default(0)
  pagesUsed       Int           @default(0)
  productsUsed    Int           @default(0)
  coursesUsed     Int           @default(0)
  studentsUsed    Int           @default(0)
  storageUsedMb   Decimal       @default(0) @db.Decimal(10, 2)
  bandwidthUsedMb Decimal       @default(0) @db.Decimal(10, 2)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation("UserToSubscription", fields: [userId], references: [id], onDelete: Cascade)
  plan            PricingPlan   @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([planId])
  @@index([status])
}

// Note: SubscriptionStatus and BillingCycle enums are defined earlier in the schema

// ==================== INTERNATIONALIZATION (i18n) ====================

model Language {
  id                String   @id @default(cuid())
  code              String   @unique // ISO 639-1 code (e.g., 'en', 'es', 'fr')
  name              String   // Display name (e.g., 'English', 'Espaol')
  nativeName        String   // Native name (e.g., 'English', 'Espaol')
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  isRTL             Boolean  @default(false) // Right-to-left support
  flagEmoji         String?  // Flag emoji for display
  locale            String?  // Full locale (e.g., 'en-US', 'es-ES')
  dateFormat        String?  // Date format preference
  numberFormat      String?  // Number format preference
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  postTranslations     PostTranslation[]
  pageTranslations     PageTranslation[]
  productTranslations  ProductTranslation[]
  courseTranslations   CourseTranslation[]
  categoryTranslations CategoryTranslation[]
  uiTranslations       UITranslation[]

  @@index([code])
  @@index([isActive])
  @@index([isDefault])
}

model PostTranslation {
  id              String   @id @default(cuid())
  postId          String
  languageId      String
  title           String
  slug            String
  content         String   @db.Text
  excerpt         String?
  metaTitle       String?
  metaDescription String?
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  post     Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([postId, languageId])
  @@unique([slug, languageId])
  @@index([postId])
  @@index([languageId])
  @@index([slug])
}

model PageTranslation {
  id              String   @id @default(cuid())
  pageId          String
  languageId      String
  title           String
  slug            String
  content         String   @db.Text
  metaTitle       String?
  metaDescription String?
  isPublished     Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  page     Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([pageId, languageId])
  @@unique([slug, languageId])
  @@index([pageId])
  @@index([languageId])
  @@index([slug])
}

model ProductTranslation {
  id               String   @id @default(cuid())
  productId        String
  languageId       String
  name             String
  slug             String
  description      String?  @db.Text
  shortDescription String?
  metaTitle        String?
  metaDescription  String?
  isPublished      Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([productId, languageId])
  @@unique([slug, languageId])
  @@index([productId])
  @@index([languageId])
  @@index([slug])
}

model CourseTranslation {
  id               String   @id @default(cuid())
  courseId         String
  languageId       String
  title            String
  slug             String
  description      String?  @db.Text
  shortDescription String?
  whatYouLearn     Json?
  requirements     Json?
  isPublished      Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([courseId, languageId])
  @@unique([slug, languageId])
  @@index([courseId])
  @@index([languageId])
  @@index([slug])
}

model CategoryTranslation {
  id          String   @id @default(cuid())
  categoryId  String
  languageId  String
  name        String
  slug        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  language Language        @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([categoryId, languageId])
  @@unique([slug, languageId])
  @@index([categoryId])
  @@index([languageId])
}

// UI Translation strings for admin panel and themes
model UITranslation {
  id         String   @id @default(cuid())
  languageId String
  namespace  String   // e.g., 'admin', 'theme', 'common'
  key        String   // e.g., 'buttons.save', 'messages.welcome'
  value      String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([languageId, namespace, key])
  @@index([languageId])
  @@index([namespace])
  @@index([key])
}

// ==================== MARKETING LISTS ====================

model MarketingList {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        MarketingListType @default(MANUAL)
  segment     String?  // Segment criteria (e.g., 'active_demos', 'expired_demos', 'high_engagement')
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscribers MarketingSubscriber[]
  campaigns   MarketingCampaign[]

  @@index([type])
  @@index([isActive])
}

model MarketingSubscriber {
  id              String   @id @default(cuid())
  email           String
  name            String?
  company         String?
  phone           String?
  source          String?  // 'demo', 'signup', 'import', etc.
  sourceId        String?  // Reference to source (e.g., demoInstanceId)

  // Engagement data
  engagementScore Int      @default(0)
  lastActivityAt  DateTime?
  sessionCount    Int      @default(0)
  totalTimeSpent  Int      @default(0) // in minutes

  // Email preferences
  isSubscribed    Boolean  @default(true)
  unsubscribedAt  DateTime?
  unsubscribeReason String?

  // Segmentation tags
  tags            Json?    // Array of tags for segmentation
  customFields    Json?    // Additional custom data

  listId          String
  list            MarketingList @relation(fields: [listId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([email, listId])
  @@index([email])
  @@index([listId])
  @@index([source])
  @@index([engagementScore])
  @@index([isSubscribed])
}

model MarketingCampaign {
  id          String   @id @default(cuid())
  name        String
  subject     String
  content     String   @db.Text
  status      CampaignStatus @default(DRAFT)

  listId      String
  list        MarketingList @relation(fields: [listId], references: [id])

  sentAt      DateTime?
  sentCount   Int      @default(0)
  openCount   Int      @default(0)
  clickCount  Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([listId])
  @@index([status])
}

enum MarketingListType {
  MANUAL
  AUTO_DEMO_USERS
  AUTO_ACTIVE_DEMOS
  AUTO_EXPIRED_DEMOS
  AUTO_HIGH_ENGAGEMENT
  IMPORTED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}
