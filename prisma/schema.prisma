// Prisma Schema for WordPress Node CMS
// This defines all database models for our CMS platform

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["metrics", "tracing"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL") // For migrations (bypasses connection pooler)
}

// User model with role-based access control
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  username  String?  @unique  // Public username/handle
  name      String
  password  String   // Hashed with bcrypt
  role      UserRole @default(AUTHOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile fields
  avatar       String?   // Profile picture URL
  coverImage   String?   // Profile banner/cover image
  bio          String?   // Short bio (displayed on cards)
  about        String?   @db.Text // Full about section (HTML)
  headline     String?   // Professional headline/tagline
  location     String?   // City, Country
  website      String?   // Personal website URL
  company      String?   // Company/organization
  jobTitle     String?   // Current job title
  skills       String[]  // Array of skills/expertise
  interests    String[]  // Array of interests
  isPublic     Boolean   @default(true) // Public profile visibility

  // Social links (JSON object)
  socialLinks  Json?     // { twitter, linkedin, github, youtube, instagram, facebook, etc. }

  // Profile stats (denormalized for performance)
  followersCount  Int @default(0)
  followingCount  Int @default(0)
  postsCount      Int @default(0)
  coursesCount    Int @default(0)

  // 2FA fields
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  // Encrypted TOTP secret
  recoveryCodes    Json?    // Array of hashed recovery codes

  // Security tracking
  failedLoginAttempts Int      @default(0)
  lastFailedLogin     DateTime?
  accountLockedUntil  DateTime?
  lastLoginAt         DateTime?
  lastLoginIp         String?

  // Relations
  posts           Post[]
  pages           Page[]
  media           Media[]
  pageViews       PageView[]
  sessions        Session[]
  securityEvents  SecurityEvent[]
  passwordHistory PasswordHistory[]
  ownedGroups     Group[]         @relation("GroupOwner")
  groupMemberships GroupMember[]
  groupMessages   GroupMessage[]

  // LMS Relations
  instructedCourses Course[]        @relation("CourseInstructor")
  enrollments       Enrollment[]    @relation("UserEnrollments")
  lessonProgress    LessonProgress[] @relation("UserLessonProgress")
  quizAttempts      QuizAttempt[]   @relation("UserQuizAttempts")
  certificates      Certificate[]   @relation("UserCertificates")

  // Follow system
  followers     UserFollow[]  @relation("FollowedUser")
  following     UserFollow[]  @relation("FollowerUser")

  // Badges/Achievements
  badges        UserBadge[]

  // Direct Messaging
  conversationsAsP1 Conversation[]  @relation("ConversationParticipant1")
  conversationsAsP2 Conversation[]  @relation("ConversationParticipant2")
  directMessages    DirectMessage[] @relation("DirectMessageSender")

  // Custom Themes
  customThemes      CustomTheme[]

  // Email System
  emailTemplatesCreated EmailTemplate[] @relation("EmailTemplateCreator")
  emailsReceived        EmailLog[]      @relation("EmailRecipient")

  // Theme Marketplace
  submittedThemes       MarketplaceTheme[] @relation("MarketplaceThemeSubmitter")
  approvedThemes        MarketplaceTheme[] @relation("MarketplaceThemeApprover")
  themeRatings          MarketplaceThemeRating[]

  // Plugin Marketplace
  submittedPlugins      MarketplacePlugin[] @relation("MarketplacePluginSubmitter")
  approvedPlugins       MarketplacePlugin[] @relation("MarketplacePluginApprover")
  pluginRatings         MarketplacePluginRating[]

  // Notifications
  notifications         Notification[] @relation("UserNotifications")

  // Backups
  backups               Backup[] @relation("UserBackups")

  // Recommendations System
  userInteractions      UserInteraction[]
  recommendationClicks  RecommendationClick[]
}

// Follow relationship for users
model UserFollow {
  id          String   @id @default(uuid())
  followerId  String   // User who follows
  followingId String   // User being followed
  createdAt   DateTime @default(now())

  follower    User @relation("FollowerUser", fields: [followerId], references: [id], onDelete: Cascade)
  following   User @relation("FollowedUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Badges/Achievements system
model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?  // Icon URL or emoji
  color       String?  // Badge color
  category    String?  // e.g., "learning", "contribution", "engagement"
  criteria    Json?    // Criteria for earning the badge
  createdAt   DateTime @default(now())

  users       UserBadge[]
}

// User-Badge relationship
model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  metadata  Json?    // Additional context (e.g., which course completed)

  user      User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

enum UserRole {
  ADMIN
  EDITOR
  AUTHOR
  VIEWER
}

// Content Type model - allows defining custom content types
model ContentType {
  id          String   @id @default(uuid())
  name        String   @unique // e.g., "Product", "Event"
  slug        String   @unique
  description String?
  icon        String?
  fields      Json     // Array of field definitions
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Post model - blog posts
model Post {
  id            String      @id @default(uuid())
  title         String
  slug          String      @unique
  content       String      @db.Text
  excerpt       String?
  featuredImage String?
  status        PostStatus  @default(DRAFT)
  publishedAt   DateTime?
  authorId      String
  author        User        @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // SEO fields (can be extended by plugins)
  metaTitle       String?
  metaDescription String?

  // Custom fields (JSON for flexibility)
  customFields  Json?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Menu items linking to this post
  menuItems     MenuItem[]

  // Post customization
  customization PostCustomization?

  @@index([slug])
  @@index([status])
  @@index([authorId])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Page model - static pages
model Page {
  id            String     @id @default(uuid())
  title         String
  slug          String     @unique
  content       String     @db.Text
  template      String?    // Template name from theme
  featuredImage String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  authorId      String
  author        User       @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // SEO fields
  metaTitle       String?
  metaDescription String?

  // Custom fields
  customFields  Json?

  // Hierarchy support
  parentId      String?
  parent        Page?      @relation("PageHierarchy", fields: [parentId], references: [id])
  children      Page[]     @relation("PageHierarchy")

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Menu items linking to this page
  menuItems     MenuItem[]

  // Page customization
  customization PageCustomization?

  @@index([slug])
  @@index([status])
  @@index([authorId])
}

// Media Library model
model Media {
  id          String   @id @default(uuid())
  filename    String
  originalName String
  path        String   // Relative path or URL
  mimeType    String
  size        Int      // Size in bytes
  width       Int?     // For images
  height      Int?     // For images
  alt         String?
  caption     String?
  uploadedById String
  uploadedBy   User    @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([uploadedById])
  @@index([mimeType])
}

// Theme model - manages installed themes
model Theme {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  version     String
  author      String?
  description String?
  thumbnail   String?
  path        String   // Path to theme directory
  config      Json     // theme.json content
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Theme customization relations
  customizationImages   ThemeCustomizationImage[]
  customizationBlocks   ThemeCustomizationBlock[]
  customizationLinks    ThemeCustomizationLink[]

  @@index([isActive])
}

// CustomTheme model - user-created themes from Theme Designer
model CustomTheme {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  settings    Json     // Full theme configuration (colors, typography, layout, etc.)
  customCSS   String?  @db.Text // Custom CSS code
  pages       Json?    // Array of theme pages with blocks for page builder
  isActive    Boolean  @default(false)
  isDefault   Boolean  @default(false)
  previewUrl  String?  // URL to preview image
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([createdById])
}

// MarketplaceTheme model - themes submitted to the marketplace
model MarketplaceTheme {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String?  @db.Text
  longDescription String?  @db.Text
  version         String
  author          String
  authorEmail     String?
  authorUrl       String?

  // Theme package
  thumbnailUrl    String?  // Preview image URL
  screenshotUrls  Json?    // Array of additional screenshot URLs
  downloadUrl     String?  // URL to download the theme ZIP
  demoUrl         String?  // Live demo URL
  repositoryUrl   String?  // GitHub/GitLab repository URL
  fileSize        Int?     // Size in bytes

  // Categorization
  category        String   @default("blog") // blog, business, portfolio, ecommerce, magazine, etc.
  tags            Json?    // Array of tags
  features        Json?    // Array of feature strings

  // Pricing
  price           Float    @default(0)
  isPremium       Boolean  @default(false)

  // Stats & Ratings
  downloads       Int      @default(0)
  rating          Float    @default(0)
  ratingCount     Int      @default(0)

  // Approval workflow
  status          String   @default("pending") // pending, approved, rejected, suspended
  submittedById   String?
  submittedBy     User?    @relation("MarketplaceThemeSubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  approvedById    String?
  approvedBy      User?    @relation("MarketplaceThemeApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectionReason String?

  // Featured/Promoted
  isFeatured      Boolean  @default(false)
  featuredOrder   Int?

  // Compatibility
  minVersion      String?  // Minimum CMS version required
  maxVersion      String?  // Maximum CMS version supported

  // Metadata
  changelog       String?  @db.Text
  documentation   String?  @db.Text
  supportUrl      String?
  licenseType     String?  @default("GPL-2.0")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  ratings         MarketplaceThemeRating[]

  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([downloads])
  @@index([rating])
  @@index([submittedById])
}

// MarketplaceThemeRating model - user ratings for marketplace themes
model MarketplaceThemeRating {
  id        String   @id @default(uuid())
  themeId   String
  theme     MarketplaceTheme @relation(fields: [themeId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5 stars
  review    String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([themeId, userId])
  @@index([themeId])
  @@index([userId])
}

// PageCustomization model - per-page theme customization
model PageCustomization {
  id              String   @id @default(uuid())
  pageId          String   @unique
  page            Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  // Layout settings
  layout          String?  // 'default', 'full-width', 'sidebar-left', 'sidebar-right'
  showHeader      Boolean  @default(true)
  showFooter      Boolean  @default(true)
  showSidebar     Boolean  @default(false)

  // Styling
  customCSS       String?  @db.Text
  backgroundColor String?
  textColor       String?

  // Header/Footer customization
  headerStyle     String?  // 'default', 'minimal', 'transparent'
  footerStyle     String?  // 'default', 'minimal', 'full'

  // Featured image
  featuredImagePosition String? // 'top', 'background', 'hidden'

  // Metadata
  customFields    Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pageId])
}

// PostCustomization model - per-post theme customization
model PostCustomization {
  id              String   @id @default(uuid())
  postId          String   @unique
  post            Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // Layout settings
  layout          String?  // 'default', 'full-width', 'sidebar-left', 'sidebar-right'
  showHeader      Boolean  @default(true)
  showFooter      Boolean  @default(true)
  showSidebar     Boolean  @default(false)

  // Author display
  showAuthor      Boolean  @default(true)
  showDate        Boolean  @default(true)
  showCategory    Boolean  @default(true)
  showTags        Boolean  @default(true)

  // Related posts
  showRelatedPosts Boolean @default(true)
  relatedPostsCount Int    @default(3)

  // Styling
  customCSS       String?  @db.Text
  backgroundColor String?
  textColor       String?

  // Featured image
  featuredImagePosition String? // 'top', 'background', 'hidden'

  // Metadata
  customFields    Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([postId])
}

// ThemeCustomizationImage model - manages theme images (logo, hero, backgrounds, etc.)
model ThemeCustomizationImage {
  id              String   @id @default(uuid())
  themeId         String
  theme           Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Image metadata
  name            String   // e.g., 'logo', 'hero-image', 'background'
  type            String   // 'logo', 'hero', 'background', 'featured', 'banner', 'custom'
  url             String   // URL to the image
  altText         String?  // Alt text for accessibility
  title           String?  // Display title
  description     String?  // Description of the image

  // Image properties
  width           Int?     // Image width in pixels
  height          Int?     // Image height in pixels
  mimeType        String?  // e.g., 'image/png', 'image/jpeg'
  fileSize        Int?     // File size in bytes

  // Usage metadata
  section         String?  // Which section uses this image (e.g., 'header', 'hero', 'footer')
  position        Int      @default(0) // Order/position in the section

  // Metadata
  customData      Json?    // Additional custom properties
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([themeId])
  @@index([type])
  @@index([section])
}

// ThemeCustomizationBlock model - manages content blocks/sections
model ThemeCustomizationBlock {
  id              String   @id @default(uuid())
  themeId         String
  theme           Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Block metadata
  name            String   // e.g., 'hero-section', 'features', 'testimonials'
  type            String   // 'hero', 'features', 'testimonials', 'cta', 'gallery', 'text', 'custom'
  title           String?  // Block title/heading
  description     String?  // Block description

  // Content
  content         String?  @db.Text // HTML or text content
  richContent     Json?    // Structured content (for rich editors)

  // Styling
  backgroundColor String?  // Background color
  textColor       String?  // Text color
  customCSS       String?  @db.Text // Custom CSS for this block

  // Layout
  layout          String?  // 'full-width', 'contained', 'grid', 'flex'
  columns         Int      @default(1) // Number of columns for grid layouts
  padding         String?  // Padding (e.g., '20px', '2rem')
  margin          String?  // Margin (e.g., '20px', '2rem')

  // Media
  backgroundImage String?  // Background image URL
  featuredImage   String?  // Featured image URL

  // Visibility & Ordering
  isVisible       Boolean  @default(true)
  position        Int      @default(0) // Order in the theme

  // Metadata
  customData      Json?    // Additional custom properties
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([themeId])
  @@index([type])
  @@index([position])
}

// ThemeCustomizationLink model - manages theme links (nav, social, CTA, etc.)
model ThemeCustomizationLink {
  id              String   @id @default(uuid())
  themeId         String
  theme           Theme    @relation(fields: [themeId], references: [id], onDelete: Cascade)

  // Link metadata
  name            String   // e.g., 'home', 'about', 'facebook', 'cta-button'
  type            String   // 'navigation', 'social', 'cta', 'footer', 'custom'
  label           String   // Display text for the link
  url             String   // Link URL

  // Link properties
  icon            String?  // Icon class or name (e.g., 'facebook', 'twitter')
  target          String   @default("_self") // '_self', '_blank', '_parent', '_top'
  rel             String?  // rel attribute (e.g., 'noopener noreferrer')
  title           String?  // Title attribute for hover text

  // Styling
  className       String?  // CSS class names
  customCSS       String?  @db.Text // Custom CSS for this link

  // Grouping & Ordering
  group           String?  // Group links together (e.g., 'main-nav', 'social-links', 'footer-links')
  position        Int      @default(0) // Order within the group

  // Visibility
  isVisible       Boolean  @default(true)
  isActive        Boolean  @default(true)

  // Metadata
  customData      Json?    // Additional custom properties
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([themeId])
  @@index([type])
  @@index([group])
  @@index([position])
}

// Plugin model - manages installed plugins
model Plugin {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  version     String
  author      String?
  description String?
  path        String   // Path to plugin directory
  config      Json     // plugin.json content
  isActive    Boolean  @default(false)
  settings    Json?    // Plugin-specific settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// Settings model - global site settings
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  type      String   // 'string', 'number', 'boolean', 'json'
  group     String?  // Group settings together (e.g., 'general', 'seo', 'theme')
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

// Session model - for admin session management
model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  ip           String?
  userAgent    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([token])
}

// PageView model - for analytics plugin
model PageView {
  id          String   @id @default(uuid())
  path        String
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId   String?
  ipAddress   String?
  userAgent   String?
  referer     String?
  // Enhanced tracking fields
  country     String?
  city        String?
  device      String?  // desktop, mobile, tablet
  browser     String?
  os          String?
  duration    Int?     // time spent on page in seconds
  scrollDepth Int?     // percentage scrolled (0-100)
  createdAt   DateTime @default(now())

  @@index([path])
  @@index([createdAt])
  @@index([sessionId])
  @@index([device])
  @@index([country])
}

// Analytics Event - track custom events
model AnalyticsEvent {
  id         String   @id @default(uuid())
  sessionId  String?
  userId     String?
  category   String   // e.g., "button", "form", "video", "purchase"
  action     String   // e.g., "click", "submit", "play", "complete"
  label      String?  // optional label for additional context
  value      Float?   // optional numeric value
  path       String?  // page where event occurred
  metadata   Json?    // additional event data
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([category])
  @@index([action])
  @@index([sessionId])
  @@index([createdAt])
}

// Analytics Session - track user sessions
model AnalyticsSession {
  id          String    @id @default(uuid())
  userId      String?
  ipAddress   String?
  userAgent   String?
  device      String?
  browser     String?
  os          String?
  country     String?
  city        String?
  referer     String?
  landingPage String?
  exitPage    String?
  pageCount   Int       @default(0)
  duration    Int       @default(0) // total session duration in seconds
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  isActive    Boolean   @default(true)

  @@index([userId])
  @@index([startedAt])
  @@index([isActive])
}

// SEO Redirect - manage URL redirects
model SeoRedirect {
  id          String   @id @default(uuid())
  fromPath    String   @unique // Source path (e.g., /old-page)
  toPath      String   // Destination path or URL
  type        Int      @default(301) // 301 (permanent) or 302 (temporary)
  isActive    Boolean  @default(true)
  hitCount    Int      @default(0) // Number of times redirect was triggered
  lastHitAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([fromPath])
  @@index([isActive])
}

// SEO Sitemap Entry - custom sitemap entries
model SeoSitemapEntry {
  id          String   @id @default(uuid())
  url         String   @unique // Full URL or path
  priority    Float    @default(0.5) // 0.0 to 1.0
  changefreq  String   @default("weekly") // always, hourly, daily, weekly, monthly, yearly, never
  lastmod     DateTime @default(now())
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// SEO Schema Markup - JSON-LD structured data
model SeoSchemaMarkup {
  id          String   @id @default(uuid())
  name        String   // Friendly name for the schema
  type        String   // Schema type: Organization, LocalBusiness, Article, Product, etc.
  content     Json     // The actual JSON-LD content
  scope       String   @default("global") // global, post, page, product, etc.
  scopeId     String?  // Optional: specific content ID to attach to
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([scope])
  @@index([isActive])
}

// SEO Audit Log - track SEO score changes
model SeoAuditLog {
  id          String   @id @default(uuid())
  contentType String   // post, page, product, course
  contentId   String
  score       Int      // 0-100 SEO score
  issues      Json     // Array of issues found
  suggestions Json     // Array of improvement suggestions
  createdAt   DateTime @default(now())

  @@index([contentType, contentId])
  @@index([createdAt])
}

// SecurityEvent model - tracks all security-related events
model SecurityEvent {
  id        String            @id @default(uuid())
  userId    String?
  user      User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  type      SecurityEventType
  ip        String?
  userAgent String?
  metadata  Json?             // Additional event-specific data
  createdAt DateTime          @default(now())

  @@index([userId])
  @@index([type])
  @@index([ip])
  @@index([createdAt])
}

enum SecurityEventType {
  SUCCESS_LOGIN
  FAILED_LOGIN
  LOGOUT
  FAILED_2FA
  LOCKOUT_TRIGGERED
  LOCKOUT_RELEASED
  PASSWORD_CHANGE
  EMAIL_CHANGE
  TWO_FA_ENABLED
  TWO_FA_DISABLED
  BLOCKED_REQUEST
  INTEGRITY_SCAN
  IP_BLOCKED
  IP_UNBLOCKED
  SECURITY_CHECK
}

// BlockedIP model - manages IP-based access control
model BlockedIP {
  id        String    @id @default(uuid())
  ip        String    @unique
  reason    String
  expiresAt DateTime? // Null for permanent blocks
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([ip])
  @@index([expiresAt])
}

// Rate Limiting Configuration
model RateLimitConfig {
  id            String   @id @default(uuid())
  endpoint      String   @unique // e.g., "/api/auth/login", "global"
  windowMs      Int      @default(60000) // Time window in milliseconds
  maxRequests   Int      @default(100) // Max requests per window
  enabled       Boolean  @default(true)
  blockDuration Int?     // Duration to block IP in minutes if exceeded
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Rate Limit Violations - tracks IPs that exceeded limits
model RateLimitViolation {
  id         String   @id @default(uuid())
  ip         String
  endpoint   String
  requests   Int      // Number of requests made
  limit      Int      // Limit that was exceeded
  blockedAt  DateTime @default(now())
  expiresAt  DateTime?
  createdAt  DateTime @default(now())

  @@index([ip])
  @@index([endpoint])
}

// Password Policy Configuration
model PasswordPolicy {
  id                      String   @id @default(uuid())
  minLength               Int      @default(8)
  requireUppercase        Boolean  @default(true)
  requireLowercase        Boolean  @default(true)
  requireNumbers          Boolean  @default(true)
  requireSpecialChars     Boolean  @default(true)
  expirationDays          Int?     // null = no expiration
  preventReuse            Int      @default(5) // number of previous passwords to check
  checkBreachedPasswords  Boolean  @default(false)
  enabled                 Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Password History for preventing reuse
model PasswordHistory {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  password  String   // hashed password
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// DIRECT MESSAGING MODELS
// ============================================

// Conversation model - represents a DM conversation between two users
model Conversation {
  id           String    @id @default(uuid())
  participant1Id String
  participant2Id String
  lastMessageAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  participant1 User   @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User   @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages     DirectMessage[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([lastMessageAt])
}

// DirectMessage model - individual messages in a conversation
model DirectMessage {
  id             String    @id @default(uuid())
  conversationId String
  senderId       String
  content        String    @db.Text
  isRead         Boolean   @default(false)
  readAt         DateTime?
  createdAt      DateTime  @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("DirectMessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isRead])
}

// ============================================
// GROUPS & LIVE CHAT MODELS
// ============================================

// Group model for community groups with live chat
model Group {
  id          String          @id @default(uuid())
  name        String
  slug        String          @unique
  description String?
  visibility  GroupVisibility @default(PUBLIC)
  ownerId     String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  owner    User           @relation("GroupOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members  GroupMember[]
  messages GroupMessage[]

  @@index([slug])
  @@index([ownerId])
  @@index([visibility])
  @@index([createdAt])
}

enum GroupVisibility {
  PUBLIC
  PRIVATE
}

// Group membership with roles and moderation
model GroupMember {
  id       String          @id @default(uuid())
  groupId  String
  userId   String
  role     GroupMemberRole @default(MEMBER)
  isBanned Boolean         @default(false)
  joinedAt DateTime        @default(now())

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([joinedAt])
}

enum GroupMemberRole {
  OWNER
  MODERATOR
  MEMBER
}

// Group chat messages
model GroupMessage {
  id        String   @id @default(uuid())
  groupId   String
  senderId  String
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  group  Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([senderId])
  @@index([createdAt])
}

// Navigation Menu model
model Menu {
  id        String     @id @default(uuid())
  name      String     @unique // e.g., "main", "footer", "sidebar"
  location  String     @unique // e.g., "header", "footer"
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  items MenuItem[]
}

// Menu Item model
model MenuItem {
  id         String     @id @default(uuid())
  menuId     String
  parentId   String?    // For nested/dropdown menus
  label      String     // Display text
  url        String?    // Custom URL
  target     String     @default("_self") // _self, _blank
  type       MenuItemType @default(CUSTOM)
  pageId     String?    // Link to Page
  postId     String?    // Link to Post
  order      Int        @default(0)
  cssClass   String?    // Optional custom CSS class
  icon       String?    // Optional icon class
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  menu     Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  parent   MenuItem?  @relation("MenuItemChildren", fields: [parentId], references: [id])
  children MenuItem[] @relation("MenuItemChildren")
  page     Page?      @relation(fields: [pageId], references: [id], onDelete: SetNull)
  post     Post?      @relation(fields: [postId], references: [id], onDelete: SetNull)

  @@index([menuId])
  @@index([parentId])
  @@index([order])
}

enum MenuItemType {
  CUSTOM    // Custom URL
  PAGE      // Link to a page
  POST      // Link to a post
  HOME      // Home page link
  CATEGORY  // Category archive (future)
  LOGIN     // Login/Logout link
}

// ============================================
// E-COMMERCE / SHOP MODELS
// ============================================

// Product Category
model ProductCategory {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
  @@index([parentId])
}

// Product model
model Product {
  id              String          @id @default(uuid())
  name            String
  slug            String          @unique
  description     String?         @db.Text
  shortDescription String?
  sku             String?         @unique
  price           Decimal         @db.Decimal(10, 2)
  salePrice       Decimal?        @db.Decimal(10, 2)
  costPrice       Decimal?        @db.Decimal(10, 2)
  stock           Int             @default(0)
  lowStockThreshold Int           @default(5)
  trackStock      Boolean         @default(true)
  status          ProductStatus   @default(DRAFT)
  type            ProductType     @default(PHYSICAL)
  featuredImage   String?
  images          Json?           // Array of image URLs
  weight          Decimal?        @db.Decimal(10, 3)
  dimensions      Json?           // {length, width, height}

  // Digital product fields
  downloadUrl     String?
  downloadLimit   Int?
  downloadExpiry  Int?            // Days after purchase

  // SEO
  metaTitle       String?
  metaDescription String?

  // Relations
  categoryId      String?
  category        ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  variants        ProductVariant[]
  tags            ProductTag[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         ProductReview[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([sku])
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ProductType {
  PHYSICAL
  DIGITAL
  SERVICE
}

// Product Variant (size, color, etc.)
model ProductVariant {
  id          String    @id @default(uuid())
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String    // e.g., "Large / Red"
  sku         String?   @unique
  price       Decimal?  @db.Decimal(10, 2)  // Override product price
  salePrice   Decimal?  @db.Decimal(10, 2)
  stock       Int       @default(0)
  image       String?
  options     Json      // {size: "Large", color: "Red"}
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@index([productId])
  @@index([sku])
}

// Product Tags
model ProductTag {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())

  @@index([slug])
}


// Shopping Cart
model Cart {
  id          String     @id @default(uuid())
  userId      String?    @unique // Null for guest carts
  sessionId   String?    @unique // For guest carts
  items       CartItem[]
  couponCode  String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([userId])
  @@index([sessionId])
}

// Cart Item
model CartItem {
  id          String          @id @default(uuid())
  cartId      String
  cart        Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)

  // Product-based items
  productId   String?
  product     Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Course-based items
  courseId    String?
  course      Course?         @relation(fields: [courseId], references: [id], onDelete: Cascade)

  quantity    Int             @default(1)
  itemType    CartItemType    @default(PRODUCT)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([cartId, productId, variantId])
  @@unique([cartId, courseId])
  @@index([cartId])
  @@index([productId])
  @@index([courseId])
}

enum CartItemType {
  PRODUCT
  COURSE
}

// Customer addresses
model CustomerAddress {
  id          String    @id @default(uuid())
  userId      String
  type        AddressType @default(SHIPPING)
  isDefault   Boolean   @default(false)
  firstName   String
  lastName    String
  company     String?
  address1    String
  address2    String?
  city        String
  state       String?
  postalCode  String
  country     String
  phone       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([type])
}

enum AddressType {
  SHIPPING
  BILLING
}

// Order
model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  userId          String?
  email           String
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)

  // Pricing
  subtotal        Decimal       @db.Decimal(10, 2)
  tax             Decimal       @db.Decimal(10, 2) @default(0)
  shipping        Decimal       @db.Decimal(10, 2) @default(0)
  discount        Decimal       @db.Decimal(10, 2) @default(0)
  total           Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")

  // Coupon
  couponCode      String?
  couponDiscount  Decimal?      @db.Decimal(10, 2)

  // Addresses
  billingAddress  Json
  shippingAddress Json?

  // Shipping
  shippingMethod  String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Notes
  customerNote    String?
  adminNote       String?

  // Relations
  items           OrderItem[]
  payments        Payment[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderNumber])
  @@index([userId])
  @@index([email])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_REFUNDED
  REFUNDED
  FAILED
}

// Order Item
model OrderItem {
  id          String          @id @default(uuid())
  orderId     String
  order       Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  variantId   String?
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  name        String          // Snapshot of product name
  sku         String?         // Snapshot of SKU
  price       Decimal         @db.Decimal(10, 2)
  quantity    Int
  total       Decimal         @db.Decimal(10, 2)
  options     Json?           // Snapshot of variant options

  createdAt   DateTime        @default(now())

  @@index([orderId])
  @@index([productId])
}

// Payment
model Payment {
  id                  String        @id @default(uuid())
  orderId             String
  order               Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("USD")
  status              PaymentStatus @default(UNPAID)
  method              String        @default("stripe")

  // Stripe fields
  stripePaymentIntentId String?     @unique
  stripeChargeId      String?
  stripeCustomerId    String?
  stripeReceiptUrl    String?

  // Refund info
  refundedAmount      Decimal?      @db.Decimal(10, 2)
  refundReason        String?
  refundedAt          DateTime?

  metadata            Json?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([orderId])
  @@index([stripePaymentIntentId])
  @@index([status])
}

// Coupon/Discount
model Coupon {
  id              String      @id @default(uuid())
  code            String      @unique
  description     String?
  type            CouponType  @default(PERCENTAGE)
  value           Decimal     @db.Decimal(10, 2)
  minOrderAmount  Decimal?    @db.Decimal(10, 2)
  maxDiscount     Decimal?    @db.Decimal(10, 2)
  usageLimit      Int?
  usageCount      Int         @default(0)
  perUserLimit    Int?
  startsAt        DateTime?
  expiresAt       DateTime?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([code])
  @@index([isActive])
}

enum CouponType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

// Product Review
model ProductReview {
  id          String    @id @default(uuid())
  productId   String
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId      String?
  name        String
  email       String
  rating      Int       // 1-5
  title       String?
  content     String?   @db.Text
  isVerified  Boolean   @default(false) // Verified purchase
  isApproved  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([productId])
  @@index([rating])
  @@index([isApproved])
}

// Tax Rate
model TaxRate {
  id          String    @id @default(uuid())
  name        String
  rate        Decimal   @db.Decimal(5, 4) // e.g., 0.0825 for 8.25%
  country     String
  state       String?
  postalCodes String?   // Comma-separated postal codes or ranges
  isDefault   Boolean   @default(false)
  priority    Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([country])
  @@index([isActive])
}

// Shipping Method
model ShippingMethod {
  id          String    @id @default(uuid())
  name        String
  description String?
  cost        Decimal   @db.Decimal(10, 2)
  freeAbove   Decimal?  @db.Decimal(10, 2) // Free shipping above this amount
  minDays     Int?
  maxDays     Int?
  countries   String?   // Comma-separated country codes, null = all
  isActive    Boolean   @default(true)
  priority    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
}

// ============================================
// LMS (LEARNING MANAGEMENT SYSTEM) MODELS
// ============================================

// Course model - the main container for learning content
model Course {
  id                  String        @id @default(uuid())
  slug                String        @unique
  title               String
  description         String?       @db.Text
  shortDescription    String?
  category            String?
  level               CourseLevel   @default(BEGINNER)
  featuredImage       String?
  instructorId        String
  instructor          User          @relation("CourseInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  priceType           CoursePriceType @default(FREE)
  priceAmount         Decimal?      @db.Decimal(10, 2)
  status              CourseStatus  @default(DRAFT)
  passingScorePercent Int           @default(80)
  certificateEnabled  Boolean       @default(true)
  estimatedHours      Int?
  whatYouLearn        Json?         // Array of learning objectives
  requirements        Json?         // Array of prerequisites
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  lessons             Lesson[]
  quizzes             Quiz[]
  enrollments         Enrollment[]
  progress            LessonProgress[]
  quizAttempts        QuizAttempt[]
  certificates        Certificate[]
  cartItems           CartItem[]

  @@index([slug])
  @@index([status])
  @@index([instructorId])
  @@index([category])
  @@index([priceType])
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum CoursePriceType {
  FREE
  PAID
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Lesson model - individual lessons within a course
model Lesson {
  id               String       @id @default(uuid())
  courseId         String
  course           Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title            String
  content          String?      @db.Text
  orderIndex       Int          @default(0)
  type             LessonType   @default(VIDEO)
  videoAssetId     String?
  videoAsset       VideoAsset?  @relation(fields: [videoAssetId], references: [id], onDelete: SetNull)
  estimatedMinutes Int?
  isPreview        Boolean      @default(false)
  isRequired       Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relations
  progress         LessonProgress[]
  quiz             Quiz?        @relation("LessonQuiz")

  @@index([courseId])
  @@index([orderIndex])
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
}

// VideoAsset model - video content storage
model VideoAsset {
  id              String          @id @default(uuid())
  provider        VideoProvider   @default(UPLOAD)
  url             String?
  playbackId      String?
  filePath        String?
  durationSeconds Int?
  isProtected     Boolean         @default(true)
  thumbnailUrl    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  lessons         Lesson[]
}

enum VideoProvider {
  UPLOAD
  HLS
  YOUTUBE
  VIMEO
}

// Quiz model - assessments for courses/lessons
model Quiz {
  id                  String    @id @default(uuid())
  courseId            String
  course              Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonId            String?   @unique
  lesson              Lesson?   @relation("LessonQuiz", fields: [lessonId], references: [id], onDelete: SetNull)
  title               String
  description         String?
  timeLimitSeconds    Int?
  attemptsAllowed     Int?      // null = unlimited
  shuffleQuestions    Boolean   @default(false)
  passingScorePercent Int?      // null = use course default
  isRequired          Boolean   @default(true)
  orderIndex          Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  questions           Question[]
  attempts            QuizAttempt[]

  @@index([courseId])
  @@index([lessonId])
}

// Question model - individual quiz questions
model Question {
  id               String        @id @default(uuid())
  quizId           String
  quiz             Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  type             QuestionType  @default(MCQ)
  prompt           String        @db.Text
  optionsJson      Json?         // Array of options for MCQ/true-false
  correctAnswerJson Json         // Correct answer(s)
  explanation      String?       @db.Text
  points           Int           @default(1)
  orderIndex       Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([quizId])
  @@index([orderIndex])
}

enum QuestionType {
  MCQ              // Multiple choice single answer
  MCQ_MULTI        // Multiple choice multiple answers
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

// Enrollment model - tracks user enrollments in courses
model Enrollment {
  id          String           @id @default(uuid())
  courseId    String
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation("UserEnrollments", fields: [userId], references: [id], onDelete: Cascade)
  status      EnrollmentStatus @default(ACTIVE)
  enrolledAt  DateTime         @default(now())
  completedAt DateTime?
  expiresAt   DateTime?        // For subscription-based access
  paymentId   String?          // Reference to payment if paid course
  pricePaid   Float?           @default(0) // Amount paid for the course

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([userId])
  @@index([status])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

// LessonProgress model - tracks user progress on lessons
model LessonProgress {
  id                  String    @id @default(uuid())
  courseId            String
  course              Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonId            String
  lesson              Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  userId              String
  user                User      @relation("UserLessonProgress", fields: [userId], references: [id], onDelete: Cascade)
  videoWatchedSeconds Int       @default(0)
  lessonCompleted     Boolean   @default(false)
  completedAt         DateTime?
  lastAccessedAt      DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([courseId, lessonId, userId])
  @@index([courseId])
  @@index([lessonId])
  @@index([userId])
}

// QuizAttempt model - tracks quiz attempts and scores
model QuizAttempt {
  id             String    @id @default(uuid())
  quizId         String
  quiz           Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  courseId       String
  course         Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId         String
  user           User      @relation("UserQuizAttempts", fields: [userId], references: [id], onDelete: Cascade)
  startedAt      DateTime  @default(now())
  submittedAt    DateTime?
  scorePercent   Int?
  scorePoints    Int?
  maxPoints      Int?
  passed         Boolean   @default(false)
  answersJson    Json?     // User's answers for review
  attemptNumber  Int       @default(1)
  timeSpentSeconds Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([quizId])
  @@index([courseId])
  @@index([userId])
  @@index([attemptNumber])
}

// Certificate model - issued upon course completion
model Certificate {
  id                String    @id @default(uuid())
  certificateNumber String    @unique
  courseId          String
  course            Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId            String
  user              User      @relation("UserCertificates", fields: [userId], references: [id], onDelete: Cascade)
  issuedAt          DateTime  @default(now())
  pdfPath           String?
  pdfUrl            String?
  verificationHash  String    @unique
  metadata          Json?     // Additional info like course title at time of issue
  revokedAt         DateTime?
  revokedReason     String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([courseId])
  @@index([userId])
  @@index([verificationHash])
  @@index([certificateNumber])
}

// ==================== EMAIL SYSTEM ====================

// Email template types
enum EmailTemplateType {
  WELCOME
  PASSWORD_RESET
  ORDER_CONFIRMATION
  COURSE_ENROLLMENT
  NEWSLETTER
  PROMOTIONAL
  CUSTOM
}

// Email delivery status
enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

// Email Template model - stores reusable email templates
model EmailTemplate {
  id          String            @id @default(uuid())
  name        String            // Template name (e.g., "Welcome Email")
  slug        String            @unique // Unique identifier (e.g., "welcome-email")
  type        EmailTemplateType @default(CUSTOM)
  subject     String            // Email subject with variable support
  htmlContent String            @db.Text // HTML content with Handlebars variables
  textContent String?           @db.Text // Plain text fallback
  variables   Json?             // Available variables: [{name: "user.name", description: "User's full name"}]
  isActive    Boolean           @default(true)
  isSystem    Boolean           @default(false) // System templates can't be deleted
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdById String?
  createdBy   User?             @relation("EmailTemplateCreator", fields: [createdById], references: [id], onDelete: SetNull)

  // Email logs using this template
  emailLogs   EmailLog[]

  @@index([type])
  @@index([slug])
  @@index([isActive])
}

// Email Log model - tracks all sent emails
model EmailLog {
  id          String      @id @default(uuid())
  templateId  String?
  template    EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  recipientId String?
  recipient   User?       @relation("EmailRecipient", fields: [recipientId], references: [id], onDelete: SetNull)

  // Email details
  toEmail     String      // Recipient email address
  toName      String?     // Recipient name
  fromEmail   String      // Sender email
  fromName    String?     // Sender name
  subject     String      // Email subject
  htmlContent String?     @db.Text // Rendered HTML content
  textContent String?     @db.Text // Rendered plain text

  // Delivery tracking
  status      EmailStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  errorMessage String?    @db.Text

  // Provider tracking
  providerMessageId String? // ID from email provider (SendGrid, AWS SES, etc.)
  providerResponse  Json?   // Full response from provider

  // Metadata
  metadata    Json?       // Additional data (order ID, course ID, etc.)
  ipAddress   String?     // IP address of sender (for bulk emails)
  userAgent   String?     // User agent (for admin-sent emails)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([templateId])
  @@index([recipientId])
  @@index([toEmail])
  @@index([status])
  @@index([sentAt])
  @@index([createdAt])
}

// =====================================================
// NOTIFICATIONS
// =====================================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SYSTEM
  USER_ACTION
  CONTENT
  SECURITY
  MARKETPLACE
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  type        NotificationType @default(INFO)
  title       String
  message     String
  link        String?          // Optional link to navigate to
  icon        String?          // Icon name (e.g., 'FiFileText', 'FiUser')
  iconColor   String?          // Icon color class (e.g., 'text-blue-400')

  isRead      Boolean          @default(false)
  readAt      DateTime?

  // Metadata for additional context
  metadata    Json?            // { postId, userId, themeId, etc. }

  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
}

// =====================================================
// BACKUP SYSTEM
// =====================================================

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum BackupType {
  FULL           // Full database + files
  DATABASE       // Database only
  MEDIA          // Media files only
  THEMES         // Themes only
  PLUGINS        // Plugins only
  SCHEDULED      // Scheduled automatic backup
}

model Backup {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        BackupType   @default(FULL)
  status      BackupStatus @default(PENDING)

  // File info
  filePath    String?      // Path to backup file
  fileSize    BigInt?      // Size in bytes
  checksum    String?      // MD5/SHA256 for integrity

  // What's included
  includesDatabase Boolean  @default(true)
  includesMedia    Boolean  @default(true)
  includesThemes   Boolean  @default(true)
  includesPlugins  Boolean  @default(true)

  // Stats
  tablesCount      Int?
  recordsCount     Int?
  filesCount       Int?

  // Error handling
  errorMessage String?

  // Scheduling
  isScheduled  Boolean   @default(false)
  scheduleId   String?   // Reference to schedule config

  // Who created it
  createdById  String?
  createdBy    User?     @relation("UserBackups", fields: [createdById], references: [id], onDelete: SetNull)

  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([createdById])
}

model BackupSchedule {
  id          String   @id @default(uuid())
  name        String
  isActive    Boolean  @default(true)

  // Schedule config (cron-like)
  frequency   String   // 'daily', 'weekly', 'monthly', 'custom'
  cronExpression String? // For custom schedules
  hour        Int      @default(3)  // Hour of day (0-23)
  dayOfWeek   Int?     // 0-6 for weekly
  dayOfMonth  Int?     // 1-31 for monthly

  // What to backup
  backupType  BackupType @default(FULL)

  // Retention
  retentionDays Int    @default(30)
  maxBackups    Int    @default(10)

  lastRunAt   DateTime?
  nextRunAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([nextRunAt])
}

// =====================================================
// PLUGIN MARKETPLACE
// =====================================================

// MarketplacePlugin model - plugins submitted to the marketplace
model MarketplacePlugin {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String?  @db.Text
  longDescription String?  @db.Text
  version         String
  author          String
  authorEmail     String?
  authorUrl       String?

  // Plugin package
  iconUrl         String?  // Plugin icon URL
  screenshotUrls  Json?    // Array of screenshot URLs
  downloadUrl     String?  // URL to download the plugin ZIP
  repositoryUrl   String?  // GitHub/GitLab repository URL
  fileSize        Int?     // Size in bytes

  // Categorization
  category        String   @default("utility") // utility, seo, security, social, analytics, backup, ecommerce, etc.
  tags            Json?    // Array of tags
  features        Json?    // Array of feature strings

  // Pricing
  price           Float    @default(0)
  isPremium       Boolean  @default(false)

  // Stats & Ratings
  downloads       Int      @default(0)
  activeInstalls  Int      @default(0)
  rating          Float    @default(0)
  ratingCount     Int      @default(0)

  // Approval workflow
  status          String   @default("pending") // pending, approved, rejected, suspended
  submittedById   String?
  submittedBy     User?    @relation("MarketplacePluginSubmitter", fields: [submittedById], references: [id], onDelete: SetNull)
  approvedById    String?
  approvedBy      User?    @relation("MarketplacePluginApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectionReason String?

  // Featured/Promoted
  isFeatured      Boolean  @default(false)
  featuredOrder   Int?

  // Compatibility
  minVersion      String?  // Minimum CMS version required
  maxVersion      String?  // Maximum CMS version supported
  testedUpTo      String?  // Last tested CMS version

  // Metadata
  changelog       String?  @db.Text
  documentation   String?  @db.Text
  supportUrl      String?
  licenseType     String?  @default("MIT")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  ratings         MarketplacePluginRating[]

  @@index([status])
  @@index([category])
  @@index([isFeatured])
  @@index([downloads])
  @@index([rating])
  @@index([submittedById])
}

// MarketplacePluginRating model - user ratings for marketplace plugins
model MarketplacePluginRating {
  id        String   @id @default(uuid())
  pluginId  String
  plugin    MarketplacePlugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      // 1-5 stars
  review    String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pluginId, userId])
  @@index([pluginId])
  @@index([userId])
}

// ============================================
// RECOMMENDATIONS SYSTEM
// ============================================

// UserInteraction - tracks user interactions for personalized recommendations
model UserInteraction {
  id              String   @id @default(uuid())
  userId          String?  // nullable for anonymous users
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId       String?  // for anonymous user tracking
  contentType     String   // 'post', 'page', 'product', 'course'
  contentId       String   // ID of the content item
  interactionType String   // 'view', 'click', 'purchase', 'enroll', 'like', 'share', 'bookmark'
  metadata        Json?    // additional data (time spent, scroll depth, referrer, etc.)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([contentType, contentId])
  @@index([interactionType])
  @@index([createdAt])
}

// RecommendationRule - admin-configured recommendation rules
model RecommendationRule {
  id          String   @id @default(uuid())
  name        String
  description String?
  sourceType  String   // 'post', 'page', 'product', 'course', 'category', 'tag', 'global'
  sourceId    String?  // specific item ID, or null for all items of sourceType
  targetType  String   // what type of content to recommend: 'post', 'page', 'product', 'course'
  algorithm   String   // 'related', 'trending', 'personalized', 'manual', 'popular', 'recent'
  settings    Json?    // algorithm-specific settings (limit, timeframe, weights, etc.)
  priority    Int      @default(0) // higher priority rules take precedence
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Manual recommendation items
  manualItems ManualRecommendation[]

  @@index([sourceType, sourceId])
  @@index([targetType])
  @@index([algorithm])
  @@index([isActive])
  @@index([priority])
}

// ManualRecommendation - manually curated recommendation items
model ManualRecommendation {
  id          String   @id @default(uuid())
  ruleId      String
  rule        RecommendationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  contentType String   // type of recommended content
  contentId   String   // ID of the recommended content
  position    Int      @default(0) // display order
  createdAt   DateTime @default(now())

  @@index([ruleId])
  @@index([contentType, contentId])
}

// RecommendationCache - cached recommendations for performance
model RecommendationCache {
  id              String   @id @default(uuid())
  sourceType      String   // source content type
  sourceId        String   // source content ID
  targetType      String   // recommended content type
  algorithm       String   // algorithm used
  recommendations Json     // array of recommended item IDs with scores
  expiresAt       DateTime // cache expiration time
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([sourceType, sourceId, targetType, algorithm])
  @@index([expiresAt])
}

// RecommendationClick - tracks clicks on recommendations for analytics
model RecommendationClick {
  id                 String   @id @default(uuid())
  userId             String?
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId          String?
  sourceType         String   // what type of page they were on
  sourceId           String   // which specific content they were viewing
  recommendationType String   // 'related', 'trending', 'personalized', etc.
  clickedType        String   // type of content clicked
  clickedId          String   // ID of content clicked
  position           Int?     // position in the recommendation list (1-based)
  createdAt          DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([recommendationType])
  @@index([sourceType, sourceId])
}

// RecommendationSettings - global recommendation settings
model RecommendationSettings {
  id                    String   @id @default(uuid())
  key                   String   @unique
  value                 Json     // setting value
  description           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
